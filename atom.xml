<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ZTF</title>
  
  <subtitle>Learn1ngFun</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2021-01-23T11:43:53.908Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>Lary Zhang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>çº¿ç¨‹æ± ï¼ˆä¸€ï¼‰</title>
    <link href="http://example.com/2021/01/23/%E7%BA%BF%E7%A8%8B%E6%B1%A0(%E4%B8%80)/"/>
    <id>http://example.com/2021/01/23/%E7%BA%BF%E7%A8%8B%E6%B1%A0(%E4%B8%80)/</id>
    <published>2021-01-23T06:50:45.000Z</published>
    <updated>2021-01-23T11:43:53.908Z</updated>
    
    <content type="html"><![CDATA[<h3 id><a href="#" class="headerlink" title></a></h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¼—æ‰€å‘¨çŸ¥ï¼Œçº¿ç¨‹æ± ä¸€å…±æœ‰ 5 ç§ï¼Œå…¶ä¸­ 2 ç§ä¸ºå®šæ—¶ç±»å‹çš„ï¼Œä¸æ˜¯æˆ‘ä»¬è¿™æ¬¡è®¨è®ºçš„ç›®æ ‡ã€‚è¿™æ¬¡ä¸»è¦æ¢è®¨å¦ä¸‰ç§ï¼Œåˆ†åˆ«ä¸º newFixedThreadPoolï¼ŒnewSingleThreadExecutor å’Œ newSingleThreadExecutorã€‚è€Œé€šè¿‡æºç æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸€ç³»åˆ—çº¿ç¨‹æ± éƒ½æ˜¯å¥—å¨ƒ ThreadPoolExecutor æ–¹æ³•çš„ã€‚æ‰€ä»¥ææ¸…æ¥š ThreadPoolExecutor æ‰æ˜¯å¼„æ‡‚çº¿ç¨‹æ± çš„å…³é”®ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½†æ˜¯å¯¹äº ThreadPoolExecutor æºç çš„è®¨è®ºæˆ‘ä»¬å…ˆæ”¾åˆ°åé¢ï¼Œä¸»è¦å…ˆçœ‹ä¸€ä¸‹è¿™ä¸‰ç§çº¿ç¨‹æ± çš„è¿è¡Œæ•ˆç‡ï¼Œé¡ºä¾¿ç§‘æ™®ä¸€ä¸‹çº¿ç¨‹æ± çš„ç®€å•åº”ç”¨ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ExecutorService es1 <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ExecutorService es2 <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ExecutorService es3 <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            es1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//es2.execute(new MyTask(i));</span>            <span class="token comment" spellcheck="true">//es3.execute(new MyTask(i));</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">MyTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤§å®¶å¯ä»¥åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šè¯•ä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°åœ¨è¿™ä¸‰ç§çº¿ç¨‹æ± ä¸­ newCachedThreadPool æ•ˆç‡æ˜¯æœ€å¿«çš„ï¼Œå…¶æ¬¡æ˜¯ newFixedThreadPoolï¼Œæœ€åæ˜¯ newCachedThreadPoolã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æºç ã€‚</p><h4 id="newCachedThreadPool"><a href="#newCachedThreadPool" class="headerlink" title="newCachedThreadPool"></a>newCachedThreadPool</h4><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//æ ¸å¿ƒçº¿ç¨‹æ•°é™åˆ¶</span>                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span><span class="token comment" spellcheck="true">//æœ€å¤§çº¿ç¨‹é™åˆ¶</span>                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span><span class="token comment" spellcheck="true">// ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´</span>                              TimeUnit unit<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// æ—¶é—´å•ä½</span>                              BlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> workQueue<span class="token punctuation">,</span><span class="token comment" spellcheck="true">// ä»»åŠ¡é˜Ÿåˆ—</span>                              ThreadFactory threadFactory<span class="token punctuation">,</span><span class="token comment" spellcheck="true">// çº¿ç¨‹å·¥ç¨‹</span>                              RejectedExecutionHandler handler<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// æ‹’ç»ç­–ç•¥    </span>     <span class="token keyword">public</span> <span class="token keyword">static</span> ExecutorService <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>                                    60L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>                                    <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡æºä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡º newCachedThreadPool çš„ æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 0ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º Integer.MAX_VALUEï¼ˆå³ 2^31 - 1 = 2147483647ï¼Œ21äº¿å¤šï¼Œæ²¡æœ‰å“ªå°æœºå™¨å¯ä»¥æ‰¿å—å§ï¼Œæ‰€ä»¥å¯ä»¥ç†è§£ä¸ºä¸å—é™åˆ¶ï¼‰ï¼Œç„¶åçº¿ç¨‹çš„ç”Ÿå‘½æ—¶é•¿ä¸º 60s é‡ç‚¹æ˜¯ä»»åŠ¡é˜Ÿåˆ—ä¸º BlockingQueueã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é‚£ä¹ˆè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ BlockingQueueã€‚SynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå®ƒå‡ ä¹å°±ä¸å ç”¨å†…å­˜ã€‚æ¥ä¸‹æ¥æˆ‘ç”»äº†å¼ å›¾ã€‚</p><img src="/images/threadpool1/newCachedThreadPool.png" style="zoom:30%;"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚å›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯åœ¨éæ ¸å¿ƒçº¿ç¨‹åŒºåˆ›å»ºçš„ï¼ˆç”±äºæ ¸å¿ƒçº¿ç¨‹åŒºä¸º 0ï¼‰ï¼Œç›¸å½“äºå‡å¦‚æˆ‘æœ‰100ä»½å·¥ä½œï¼Œè€Œæˆ‘åˆèƒ½æ‰¾åˆ° 100 ä¸ªå·¥äººå¸®æˆ‘å»åšï¼Œé‚£ä¹ˆå¾ˆå¿«å°±å¯ä»¥å®Œæˆï¼Œæ‰€ä»¥ newCachedThreadPool æ¯”è¾ƒå¿«ã€‚è€Œæˆ‘ä»¬åˆçŸ¥é“ï¼Œçº¿ç¨‹æ•°å’Œ cpu æ¯æ¯ç›¸å…³ã€‚ç”±äºåˆ›å»ºçº¿ç¨‹æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨éæ ¸å¿ƒçº¿ç¨‹åŒºåˆ›å»ºï¼ŒCPU ä¼šæ¶ˆè€—å¤§é‡æ€§èƒ½å»åˆ›å»ºçº¿ç¨‹ï¼Œæ‰€ä»¥ newCachedThreadPool ææœ‰å¯èƒ½é€ æˆ CPU 100%ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€çœ‹ newFixedThreadPoolã€‚</p><h4 id="newFixedThreadPool"><a href="#newFixedThreadPool" class="headerlink" title="newFixedThreadPool"></a>newFixedThreadPool</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> ExecutorService <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>                                   0L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>                                  <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½æ˜¯ä¼ å…¥å‚æ•°ï¼Œç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ä¸º 0sï¼ˆkeepAliveTime ä¸ºéæ ¸å¿ƒçº¿ç¨‹ä½¿ç”¨å®Œåä¼šå¤šä¹…å›æ”¶ï¼Œç”±äºè¿™é‡Œæ²¡æœ‰è®¾ç½®éæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ‰€ä»¥çº¿ç¨‹ä½¿ç”¨å®Œä¸å›æ”¶ã€‚ï¼‰ï¼Œæ³¨æ„è¿™ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸º LinkedBlockingQueueã€‚LinkedBlockingQueue å†…éƒ¨åŸºäºé“¾è¡¨æ¥å­˜æ”¾å…ƒç´ ï¼Œå®ƒå¦‚æœä¸æŒ‡å®šå®¹é‡ï¼Œé»˜è®¤ä¸º Integer.MAX_VALUEï¼Œä¹Ÿå°±æ˜¯æ— ç•Œé˜Ÿåˆ—ã€‚ï¼ˆé€šå¸¸ç”¨çš„æ—¶å€™ä¼šè®¾ç½®å¤§å°ï¼Œè€Œè¿™é‡Œæ²¡è®¾ç½®ï¼Œä¸ºé»˜è®¤å€¼ã€‚ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬çŸ¥é“ä¸ºä»€ä¹ˆç¬¬äºŒä¸ªä¾‹å­ä¼šæ¯”ç¬¬ä¸€ä¸ªæ…¢äº†å§ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç”¨ 100 ä¸ªçº¿ç¨‹å»å®Œæˆä»»åŠ¡ï¼Œè€Œç¬¬äºŒä¸ªåªåˆ›å»ºäº† 10 ä¸ªã€‚ä½†æ˜¯ newFixedThreadPool ä¹Ÿæœ‰ä¸ªé—®é¢˜ï¼Œç”±äºæ²¡æœ‰è®¾ç½® LinkedBlockingQueue çš„åˆå§‹å¤§å°ï¼Œæ‰€ä»¥å®ƒä¼šæ— é™å¤§ï¼Œææœ‰å¯èƒ½ä¼šé€ æˆ OOMã€‚</p><img src="/images/threadpool1/newFixedThreadPool.png" style="zoom:30%;"><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ newSingleThreadExecutorã€‚</p><h4 id="newSingleThreadExecutor"><a href="#newSingleThreadExecutor" class="headerlink" title="newSingleThreadExecutor"></a>newSingleThreadExecutor</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> ExecutorService <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>      <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>                              0L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>                              <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é™¤äº†æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ä¸º 1 ä»¥å¤–ï¼Œå…¶ä»–çš„å’Œ newFixedThreadPool ä¸€æ ·ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡çš„è¿›è¡Œï¼Œæ‰€ä»¥ newSingleThreadExecutor æ˜¯ä¸‰ä¸ªé‡Œæœ€æ…¢çš„ã€‚å½“ç„¶äº†ï¼ŒnewSingleThreadExecutory ä¾ç„¶æœ‰å‘ç”Ÿ OOM çš„é—®é¢˜ã€‚</p><p>ä½ å¯èƒ½ä¼šå‘ç°ï¼Œå®˜æ–¹æä¾›çš„æ–¹æ³•éƒ½æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹é˜¿é‡Œçš„å¼€å‘æ‰‹å†Œæ˜¯æ€ä¹ˆè¯´çš„ã€‚</p><p>![image-20210119155348262](/Users/mbp/Library/Application Support/typora-user-images/image-20210119155348262.png)</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é‡Œé¢è¯´çš„â€œé€šè¿‡ ThreadPoolExecutorâ€ çš„æ–¹å¼å³<strong>è‡ªå®šä¹‰çº¿ç¨‹æ± </strong>ã€‚ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨é¢è¯•ä¸­å¸¸é‡è§çš„ä¸€é“é¢è¯•é¢˜ï¼šâ€œè¯·è¯´ä¸€ä¸‹è‡ªå®šä¹‰çº¿ç¨‹æ± ä¸­å‚æ•°çš„å«ä¹‰â€ã€‚é‚£ä¸ƒä¸ªæˆ‘å·²ç»åœ¨ä¸Šé¢ ThreadPoolExecutor æ„é€ å‡½æ•°é‡Œæ ‡æ³¨äº†æ³¨é‡Šï¼Œè¯¦ç»†å†…å®¹ä¸‹ä¸€ç¯‡æ€»ç»“çº¿ç¨‹æºç æ—¶ä¼šè¯´çš„ã€‚ç²—ç•¥åœ°å†™ä¸€ä¸ªå’Œæœ‹å‹äº¤æµï¼Œä»–ä»¬ç”¨åˆ°è‡ªå®šä¹‰çº¿ç¨‹æ± çš„é…ç½®å§ã€‚</p><pre class=" language-java"><code class="language-java"> ThreadPoolExecutor pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">// è‡ªå®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± </span>                <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// coreSize</span>                <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// maxSize</span>                <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 60s</span>                TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>                 <span class="token punctuation">,</span> Executors<span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h3><p>è¿™ç¯‡æ–‡ç« å…¶å®æœ‰ç‚¹æ€ªï¼Œä½†æ˜¯æ²¡åŠæ³•ï¼Œå› ä¸ºæˆ‘ä¸‹ä¸€æŠŠç¯‡ä¼šè®²æºç ï¼Œæ‰€ä»¥æœ‰å¥½å¤šç‚¹ä¸€ç¬”å¸¦è¿‡äº†ã€‚çº¿ç¨‹æ± ï¼ˆäºŒï¼‰é©¬ä¸ŠçŒ®ä¸Šã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ä¼—æ‰€å‘¨çŸ¥ï¼Œçº¿ç¨‹æ± ä¸€å…±æœ‰ 5 ç§ï¼Œå…¶ä¸­ 2 ç§ä¸ºå®šæ—¶ç±»å‹çš„ï¼Œä¸æ˜¯æˆ‘ä»¬è¿™æ¬¡è®¨</summary>
      
    
    
    
    <category term="çº¿ç¨‹" scheme="http://example.com/categories/%E7%BA%BF%E7%A8%8B/"/>
    
    
    <category term="Java" scheme="http://example.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Future æºç æµ…æ</title>
    <link href="http://example.com/2021/01/11/Future/"/>
    <id>http://example.com/2021/01/11/Future/</id>
    <published>2021-01-10T21:35:28.000Z</published>
    <updated>2021-01-10T21:39:54.295Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬éƒ½çŸ¥é“åœ¨ JAVA ä¸­ä¸€èˆ¬é€šè¿‡ç»§æ‰¿ Thread ç±»æˆ–è€…å®ç° Runnable æ¥å£ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºå¤šçº¿ç¨‹ã€‚ä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼æœ‰ä¸ªç¼ºé™·ï¼Œå°±æ˜¯ä¸èƒ½è·å–æ‰§è¡Œçš„ç»“æœã€‚å¦‚æœæƒ³è·å–ç»“æœéœ€è¦è¿ç”¨ Callable å’Œ Future æ¥å£æ¥è·å–ä»»åŠ¡ç»“æœã€‚ç”±äºæˆ‘æœ€è¿‘æƒ³çœ‹çº¿ç¨‹æ± æºç ï¼Œä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ å’Œçº¿ç¨‹æ± æœ‰å…³çš„ Futureã€‚</p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>ä½ å¯èƒ½æƒ³äº†è§£ï¼ŒFuture æ€ä¹ˆå°±å’Œçº¿ç¨‹æ± æœ‰å…³äº†å‘¢ï¼Ÿçœ‹ä¸ªå°ä¾‹å­ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>      ExecutorService threadPool <span class="token operator">=</span> Executor<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      Future f01 <span class="token operator">=</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunnableTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      f01<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      Future f02 <span class="token operator">=</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallableTask</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    f02<span class="token punctuation">.</span>cancel<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">class</span> <span class="token class-name">RunnableTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">class</span> <span class="token class-name">CallableTask</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>é€šè¿‡è¿™ä¸ªå°ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å½“æˆ‘åœ¨çº¿ç¨‹æ± æäº¤äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åæˆ‘æƒ³å¯¹æ± ä¸­æ‰§è¡Œçš„çº¿ç¨‹è¿›è¡Œä¸€äº›æ“ä½œï¼ˆgetã€cancelï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ Future å¥æŸ„ã€‚</p><p>é‚£ä¹ˆå¼€å§‹æºç é˜…è¯»å§ï¼ï¼</p><h3 id="åŸºç¡€å±æ€§"><a href="#åŸºç¡€å±æ€§" class="headerlink" title="åŸºç¡€å±æ€§"></a>åŸºç¡€å±æ€§</h3><p>é€šè¿‡çº¿ç¨‹æ±  submit çš„æ–¹å¼æäº¤çš„ runnable/callable ä¼šè¢«åŒ…è£…æˆ futureTask</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// è¡¨ç¤ºå½“å‰ task çš„çŠ¶æ€</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰ä»»åŠ¡å°šæœªæ‰§è¡Œ</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NEW          <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰ä»»åŠ¡æ­£åœ¨ç»“æŸï¼Œå°šæœªå®Œå…¨ç»“æŸï¼Œä¸€ç§ä¸´ç•ŒçŠ¶æ€</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COMPLETING   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰ä»»åŠ¡æ­£å¸¸ç»“æŸ</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NORMAL       <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå†…éƒ¨å°è£…çš„ callable.run() å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EXCEPTIONAL  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰ä»»åŠ¡è¢«å–æ¶ˆ</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CANCELLED    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰ä»»åŠ¡ä¸­æ–­ä¸­..</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INTERRUPTING <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰ä»»åŠ¡å·²ä¸­æ–­</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INTERRUPTED  <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// submit(runnable/callable) runnable ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ ä¼ªè£…æˆ Callable äº†</span>    <span class="token keyword">private</span> Callable<span class="token operator">&lt;</span>V<span class="token operator">></span> callable<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** æ­£å¸¸æƒ…å†µä¸‹ï¼šå½“å‰ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œoutcome ä¿å­˜æ‰§è¡Œç»“æœï¼Œcallable è¿”å›å€¼ */</span>    <span class="token comment" spellcheck="true">/** éæ­£å¸¸æƒ…å†µï¼šcallable å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼ŒOutcome ä¿å­˜å¼‚å¸¸*/</span>    <span class="token keyword">private</span> Object outcome<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// non-volatile, protected by state reads/writes</span>    <span class="token comment" spellcheck="true">/** å½“å‰ä»»åŠ¡è¢«çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œä¿å­˜å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å¯¹è±¡å¼•ç”¨    */</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> Thread runner<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å› ä¸ºä¼šæœ‰å¾ˆå¤šçº¿ç¨‹ä¼š get å½“å‰ä»»åŠ¡çš„ç»“æœï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†ä¸€ç§ç±»ä¼¼ å¤´æ’ å¤´å–çš„é˜Ÿåˆ— æ•°æ®ç»“æ„</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> WaitNode waiters<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å§‹ç»ˆæŒ‡å‘å¤´èŠ‚ç‚¹</span></code></pre><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><p>å½“å‚æ•°ä¸º callable çš„æ—¶å€™åˆè¿”å›å€¼æˆ‘ä»¬æ˜¯å¯ä»¥ç†è§£çš„ï¼Œæ¯•ç«Ÿäººå®¶è‡ªå¸¦è¿”å›å€¼ï¼›å¯ runnable æ˜¯ä¸ªæ— è¿”å›å€¼å‡½æ•°ï¼Œé‚£ä¹ˆå½“å‚æ•°æ˜¯ runnable çš„æ—¶å€™æ˜¯æ€ä¹ˆè·å–çš„è¿”å›å€¼å‘¢ï¼Ÿå…¶å®å®ƒä»€ä¹ˆéƒ½æ²¡æœ‰å¹²ï¼Œå®ƒæ˜¯ä¸ä¼šé€šè¿‡ä¸€ç³»åˆ—è®¡ç®—æ™ºèƒ½åœ°ç»™æˆ‘ä»¬è¿”å›ç»“æœçš„è¿”å›å€¼ï¼Œè€Œæ˜¯æ ¹æ®æˆ‘ä»¬ä¼ è¿›å»çš„å‚æ•° resultï¼Œå®ƒæ˜¯ä»€ä¹ˆç±»å‹å°±ä¼ ä»€ä¹ˆç±»å‹ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å‚æ•°ä¸º callable çš„æ„é€ å‡½æ•°</span><span class="token keyword">public</span> <span class="token function">FutureTask</span><span class="token punctuation">(</span>Callable<span class="token operator">&lt;</span>V<span class="token operator">></span> callable<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>callable <span class="token operator">==</span> null<span class="token punctuation">)</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>callable <span class="token operator">=</span> callable<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> NEW<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å°†å½“å‰ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º new</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token function">FutureTask</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">,</span> V result<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ä½¿ç”¨é€‚é…å™¨æ¨¡å¼å°† runnable è½¬æ¢ä¸º callable æ¥å£</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>callable <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">callable</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> NEW<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// ensure visibility of callable</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Callable<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">callable</span><span class="token punctuation">(</span>Runnable task<span class="token punctuation">,</span> T result<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> null<span class="token punctuation">)</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RunnableAdapter</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RunnableAdapter</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> Runnable task<span class="token punctuation">;</span>    <span class="token keyword">final</span> T result<span class="token punctuation">;</span>    <span class="token function">RunnableAdapter</span><span class="token punctuation">(</span>Runnable task<span class="token punctuation">,</span> T result<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>task <span class="token operator">=</span> task<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> T <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// æœ€åè¿”å›çš„å°±æ˜¯ä¼ è¿›æ¥çš„ resultï¼Œå…¶å®å®ƒå¹¶ä¸èƒ½æŠŠè¿ç®—ç»“æœè¿”å›å‡ºæ¥ï¼Œå…¶å®æ˜¯è£…æ¯çš„</span>      <span class="token comment" spellcheck="true">// ä¼ è¿›å•¥ è¿”å›å•¥</span>      <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="run"><a href="#run" class="headerlink" title="run()"></a>run()</h3><p>//submit(runnable/callable) -&gt; newTaskFor(runnable) -&gt; execute(task)   -&gt; pool</p><p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡çº¿ç¨‹æ± å°† runnable/callable çš„å‚æ•°æäº¤ï¼ˆsubmitï¼‰ï¼Œæäº¤è¿‡ç¨‹é€šè¿‡ newTaskFor å°†runnbale è½¬æ¢æˆ taskï¼Œæœ€å execute å°†task çœŸæ­£æäº¤åˆ° poolã€‚äº†è§£äº†å¤§è‡´æµç¨‹ï¼Œæˆ‘ä»¬å†æ¥è¯´ runã€‚å°†ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± åï¼Œå¦‚æœè¿˜æ²¡æœ‰è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆä¼šæ–°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œ run å°±æ˜¯å…¥å£ï¼›å¦‚æœè¾¾åˆ°äº†ï¼Œé‚£ä¹ˆ FutureTask å°±å…¥é˜Ÿè¿›å…¥é˜Ÿå°¾ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹å°±ä¼šæ¶ˆè´¹çº¿ç¨‹ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä»»åŠ¡æ‰§è¡Œå…¥å£    </span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//æ¡ä»¶ä¸€ï¼šstate != NEW æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰taskå·²ç»è¢«æ‰§è¡Œè¿‡äº† æˆ–è€… è¢«cancel äº†ï¼Œæ€»ä¹‹éNEWçŠ¶æ€çš„ä»»åŠ¡ï¼Œçº¿ç¨‹å°±ä¸å¤„ç†äº†ã€‚</span>              <span class="token comment" spellcheck="true">//æ¡ä»¶äºŒï¼šé€šè¿‡ cas çš„æ–¹å¼å°†å½“å‰çº¿ç¨‹èµ‹å€¼ç»™ runnerOffsetã€‚å¦‚æœå¤±è´¥ï¼Œè¯´æ˜å½“å‰ä»»åŠ¡è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> NEW <span class="token operator">||</span>            <span class="token operator">!</span>UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> runnerOffset<span class="token punctuation">,</span>                                         null<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// å½“å‰ task ä¸€å®šæ˜¯ new çŠ¶æ€ï¼Œè€Œä¸”å½“å‰çº¿ç¨‹ä¹ŸæŠ¢å  task æˆåŠŸ</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//callable å°±æ˜¯ç¨‹åºå‘˜è‡ªå·±å°è£…é€»è¾‘çš„ callable æˆ–è€…è£…é¥°åçš„ runnable</span>            Callable<span class="token operator">&lt;</span>V<span class="token operator">></span> c <span class="token operator">=</span> callable<span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// æ¡ä»¶ä¸€ï¼šé˜²æ­¢ç©ºæŒ‡é’ˆ</span>            <span class="token comment" spellcheck="true">// æ¡ä»¶äºŒï¼šé˜²æ­¢å¤–éƒ¨çº¿ç¨‹ cancel æ‰å½“å‰ä»»åŠ¡ã€‚</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">==</span> NEW<span class="token punctuation">)</span> <span class="token punctuation">{</span>                V result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç»“æœå¼•ç”¨</span>                <span class="token comment" spellcheck="true">// true è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡ŒæˆåŠŸ  æœªæŠ›å‡ºå¼‚å¸¸</span>                  <span class="token comment" spellcheck="true">// false è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡Œå¤±è´¥ æŠ›å‡ºå¼‚å¸¸</span>                <span class="token keyword">boolean</span> ran<span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//è°ƒç”¨ç¨‹åºå‘˜è‡ªå·±å®ç°çš„ callable æˆ–è€… é€‚é…å™¨è£…é¥°åçš„ runnable</span>                    result <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// æ‰§è¡ŒæˆåŠŸ</span>                    ran <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// è¯´æ˜ç¨‹åºå‘˜è‡ªå·±å†™çš„é€»è¾‘å—æœ‰ bug</span>                    result <span class="token operator">=</span> null<span class="token punctuation">;</span>                    ran <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è®¾ç½®å¼‚å¸¸ï¼Œä¸‹é¢è§£æğŸ‘‡</span>                    <span class="token function">setException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                  <span class="token comment" spellcheck="true">// å¦‚æœæ­£å¸¸ç»“æŸ,å°†ç»“æœè®¾ç½®åˆ° outcome ä¸­</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>ran<span class="token punctuation">)</span>                    <span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            runner <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> INTERRUPTING<span class="token punctuation">)</span>                <span class="token function">handlePossibleCancellationInterrupt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>V v<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//ä½¿ç”¨CASæ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çŠ¶æ€ä¸º å®Œæˆä¸­..</span>        <span class="token comment" spellcheck="true">//æœ‰æ²¡æœ‰å¯èƒ½å¤±è´¥å‘¢ï¼Ÿ å¤–éƒ¨çº¿ç¨‹ç­‰ä¸åŠäº†ï¼Œç›´æ¥åœ¨setæ‰§è¡ŒCASä¹‹å‰ å°†  taskå–æ¶ˆäº†ã€‚  å¾ˆå°æ¦‚ç‡äº‹ä»¶ã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> NEW<span class="token punctuation">,</span> COMPLETING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            outcome <span class="token operator">=</span> v<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//å°†ç»“æœèµ‹å€¼ç»™ outcomeä¹‹åï¼Œé©¬ä¸Šä¼šå°†å½“å‰ä»»åŠ¡çŠ¶æ€ä¿®æ”¹ä¸º NORMAL æ­£å¸¸ç»“æŸçŠ¶æ€ã€‚</span>            UNSAFE<span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">//æœ€èµ·ç å¾—æŠŠget() å†æ­¤é˜»å¡çš„çº¿ç¨‹ å”¤é†’..</span>            <span class="token function">finishCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setException</span><span class="token punctuation">(</span>Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//ä½¿ç”¨CASæ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çŠ¶æ€ä¸º å®Œæˆä¸­..</span>        <span class="token comment" spellcheck="true">//è§¦å‘æ¡ä»¶ï¼šå¤–éƒ¨çº¿ç¨‹ç­‰ä¸åŠäº†ï¼Œç›´æ¥åœ¨setæ‰§è¡ŒCASä¹‹å‰ å°†  taskå–æ¶ˆäº†ã€‚  å¾ˆå°æ¦‚ç‡äº‹ä»¶ã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> NEW<span class="token punctuation">,</span> COMPLETING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¼•ç”¨çš„æ˜¯ callable å‘ä¸Šå±‚æŠ›å‡ºæ¥çš„å¼‚å¸¸ã€‚</span>            outcome <span class="token operator">=</span> t<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//å°†å½“å‰ä»»åŠ¡çš„çŠ¶æ€ ä¿®æ”¹ä¸º EXCEPTIONAL</span>            UNSAFE<span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> EXCEPTIONAL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// final state</span>            <span class="token function">finishCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> V <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> ExecutionException <span class="token punctuation">{</span>    <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// è·å–å½“å‰ä»»åŠ¡çŠ¶æ€</span>      <span class="token comment" spellcheck="true">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä»»åŠ¡æœªå®Œæˆã€‚</span>      <span class="token comment" spellcheck="true">// è°ƒç”¨ get çš„å¤–éƒ¨çº¿ç¨‹ä¼šè¢«é˜»å¡åœ¨ get æ–¹æ³•ä¸Šã€‚</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;=</span> COMPLETING<span class="token punctuation">)</span>        s <span class="token operator">=</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> 0L<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">report</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span>        <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">long</span> deadline <span class="token operator">=</span> timed <span class="token operator">?</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> nanos <span class="token operator">:</span> 0L<span class="token punctuation">;</span>        WaitNode q <span class="token operator">=</span> null<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//è¡¨ç¤ºå½“å‰çº¿ç¨‹ waitNodeå¯¹è±¡ æœ‰æ²¡æœ‰ å…¥é˜Ÿ/å‹æ ˆ</span>        <span class="token keyword">boolean</span> queued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// è‡ªæ—‹</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨ä¸­æ–­æ–¹å¼å–Šé†’çš„</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// åˆ—ä¸­åˆ é™¤è¯¥èŠ‚ç‚¹å¹¶æŠ›å‡ºInterruptedExceptionå¼‚å¸¸,å‡ºé˜Ÿ</span>                <span class="token function">removeWaiter</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">//å‡è®¾å½“å‰çº¿ç¨‹æ˜¯è¢«å…¶å®ƒçº¿ç¨‹ ä½¿ç”¨unpark(thread) å”¤é†’çš„è¯ã€‚ä¼šæ­£å¸¸è‡ªæ—‹ï¼Œèµ°ä¸‹é¢é€»è¾‘ã€‚</span>            <span class="token comment" spellcheck="true">//è·å–å½“å‰ä»»åŠ¡æœ€æ–°çŠ¶æ€</span>            <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä»»åŠ¡å·²ç»æœ‰ç»“æœäº†</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">></span> COMPLETING<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å·²ç»ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºè¿‡node äº†ï¼Œæ­¤æ—¶éœ€è¦å°† node.thread = null helpGC</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">!=</span> null<span class="token punctuation">)</span>                    q<span class="token punctuation">.</span>thread <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">return</span> s<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä»»åŠ¡æ¥è¿‘å®ŒæˆçŠ¶æ€...è¿™é‡Œè®©å½“å‰çº¿ç¨‹å†é‡Šæ”¾cpu ï¼Œè¿›è¡Œä¸‹ä¸€æ¬¡æŠ¢å cpuã€‚</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> COMPLETING<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// cannot time out yet</span>                Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">//æ¡ä»¶æˆç«‹ï¼šç¬¬ä¸€æ¬¡è‡ªæ—‹ï¼Œå½“å‰çº¿ç¨‹è¿˜æœªåˆ›å»º WaitNode å¯¹è±¡ï¼Œæ­¤æ—¶ä¸ºå½“å‰çº¿ç¨‹åˆ›å»º WaitNodeå¯¹è±¡</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> null<span class="token punctuation">)</span>                q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaitNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">//æ¡ä»¶æˆç«‹ï¼šç¬¬äºŒæ¬¡è‡ªæ—‹ï¼Œå½“å‰çº¿ç¨‹å·²ç»åˆ›å»º WaitNodeå¯¹è±¡äº†ï¼Œä½†æ˜¯nodeå¯¹è±¡è¿˜æœªå…¥é˜Ÿ</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queued<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// q.next = waiters</span>                  <span class="token comment" spellcheck="true">//å½“å‰çº¿ç¨‹nodeèŠ‚ç‚¹ next æŒ‡å‘ åŸ é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹   waiters ä¸€ç›´æŒ‡å‘é˜Ÿåˆ—çš„å¤´ï¼</span>                <span class="token comment" spellcheck="true">//casæ–¹å¼è®¾ç½®waiterså¼•ç”¨æŒ‡å‘ å½“å‰çº¿ç¨‹nodeï¼Œ æˆåŠŸçš„è¯ queued == true å¦åˆ™ï¼Œå¯èƒ½å…¶å®ƒçº¿ç¨‹å…ˆä½ ä¸€æ­¥å…¥é˜Ÿäº†ã€‚</span>                queued <span class="token operator">=</span> UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> waitersOffset<span class="token punctuation">,</span>                                                     q<span class="token punctuation">.</span>next <span class="token operator">=</span> waiters<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// ç¬¬ä¸‰æ¬¡è‡ªæ—‹ å¦‚æœä¸å¸¦è¶…æ—¶çš„ get é‚£ä¹ˆä¸ä¼šèµ°åˆ°è¿™ä¸ªåˆ†æ”¯</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timed<span class="token punctuation">)</span> <span class="token punctuation">{</span>                nanos <span class="token operator">=</span> deadline <span class="token operator">-</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&lt;=</span> 0L<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">removeWaiter</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> state<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                LockSupport<span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">else</span>                  <span class="token comment" spellcheck="true">//å½“å‰getæ“ä½œçš„çº¿ç¨‹å°±ä¼šè¢«parkäº†ã€‚  çº¿ç¨‹çŠ¶æ€ä¼šå˜ä¸º WAITINGçŠ¶æ€ï¼Œç›¸å½“äºä¼‘çœ äº†..</span>                <span class="token comment" spellcheck="true">//é™¤éæœ‰å…¶å®ƒçº¿ç¨‹å°†ä½ å”¤é†’  æˆ–è€… å°†å½“å‰çº¿ç¨‹ ä¸­æ–­ã€‚</span>                LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>awaitDone()ä¸­æœ‰ä¸ªæ­»å¾ªç¯ï¼Œæ¯ä¸€æ¬¡å¾ªç¯éƒ½ä¼š</p><ol><li>åˆ¤æ–­è°ƒç”¨get()çš„çº¿ç¨‹æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­åˆ é™¤å¯¹åº”èŠ‚ç‚¹ç„¶åæŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚</li><li>è·å–ä»»åŠ¡å½“å‰çŠ¶æ€ï¼Œå¦‚æœå½“å‰ä»»åŠ¡çŠ¶æ€å¤§äºCOMPLETINGåˆ™è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œåˆ™æŠŠthreadå­—æ®µç½®nullå¹¶è¿”å›ç»“æœã€‚</li><li>å¦‚æœä»»åŠ¡å¤„äºCOMPLETINGçŠ¶æ€ï¼Œåˆ™è¡¨ç¤ºä»»åŠ¡å·²ç»å¤„ç†å®Œæˆ(æ­£å¸¸æ‰§è¡Œå®Œæˆæˆ–è€…æ‰§è¡Œå‡ºç°å¼‚å¸¸)ï¼Œä½†æ˜¯æ‰§è¡Œç»“æœæˆ–è€…å¼‚å¸¸åŸå› è¿˜æ²¡æœ‰ä¿å­˜åˆ°outcomeå­—æ®µä¸­ã€‚è¿™ä¸ªæ—¶å€™è°ƒç”¨çº¿ç¨‹è®©å‡ºæ‰§è¡Œæƒè®©å…¶ä»–çº¿ç¨‹ä¼˜å…ˆæ‰§è¡Œã€‚</li><li>å¦‚æœç­‰å¾…èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™æ„é€ ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹WaitNodeã€‚</li><li>å¦‚æœç¬¬å››æ­¥ä¸­æ–°å»ºçš„èŠ‚ç‚¹è¿˜æ²¡å¦‚é˜Ÿåˆ—ï¼Œåˆ™CASçš„æŠŠè¯¥èŠ‚ç‚¹åŠ å…¥waitersé˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ã€‚</li><li>é˜»å¡ç­‰å¾…ã€‚</li></ol><p>å‡è®¾å½“å‰state=NEWä¸”waitersä¸ºNULL,ä¹Ÿå°±æ˜¯è¯´è¿˜æ²¡æœ‰ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨get()è·å–æ‰§è¡Œç»“æœï¼Œè¿™ä¸ªæ—¶å€™æœ‰ä¸¤ä¸ªçº¿ç¨‹threadAå’ŒthreadBå…ˆåè°ƒç”¨get()æ¥è·å–æ‰§è¡Œç»“æœã€‚å†å‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹åœ¨åŠ å…¥é˜»å¡é˜Ÿåˆ—è¿›è¡Œé˜»å¡ç­‰å¾…ä¹‹å‰ä»»åŠ¡éƒ½æ²¡æœ‰æ‰§è¡Œå®Œæˆä¸”threadAå’ŒthreadBéƒ½æ²¡æœ‰è¢«ä¸­æ–­çš„æƒ…å†µä¸‹(å› ä¸ºå¦‚æœthreadAå’ŒthreadBåœ¨è¿›è¡Œé˜»å¡ç­‰å¾…ç»“æœä¹‹å‰ä»»åŠ¡å°±æ‰§è¡Œå®Œæˆæˆ–çº¿ç¨‹æœ¬èº«è¢«ä¸­æ–­çš„è¯ï¼ŒawaitDone()å°±æ‰§è¡Œç»“æŸè¿”å›äº†)ï¼Œæ‰§è¡Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œä»¥threadAä¸ºä¾‹:</p><ol><li>ç¬¬ä¸€è½®forå¾ªç¯ï¼Œæ‰§è¡Œçš„é€»è¾‘æ˜¯q == null,æ‰€ä»¥è¿™æ—¶å€™ä¼šæ–°å»ºä¸€ä¸ªèŠ‚ç‚¹qã€‚ç¬¬ä¸€è½®å¾ªç¯ç»“æŸã€‚</li><li>ç¬¬äºŒè½®forå¾ªç¯ï¼Œæ‰§è¡Œçš„é€»è¾‘æ˜¯!queueï¼Œè¿™ä¸ªæ—¶å€™ä¼šæŠŠç¬¬ä¸€è½®å¾ªç¯ä¸­ç”Ÿæˆçš„èŠ‚ç‚¹çš„netxæŒ‡é’ˆæŒ‡å‘waitersï¼Œç„¶åCASçš„æŠŠèŠ‚ç‚¹qæ›¿æ¢waitersã€‚ä¹Ÿå°±æ˜¯æŠŠæ–°ç”Ÿæˆçš„èŠ‚ç‚¹æ·»åŠ åˆ°waitersé“¾è¡¨çš„é¦–èŠ‚ç‚¹ã€‚å¦‚æœæ›¿æ¢æˆåŠŸï¼Œqueued=trueã€‚ç¬¬äºŒè½®å¾ªç¯ç»“æŸã€‚</li><li>ç¬¬ä¸‰è½®forå¾ªç¯ï¼Œè¿›è¡Œé˜»å¡ç­‰å¾…ã€‚è¦ä¹ˆé˜»å¡ç‰¹å®šæ—¶é—´ï¼Œè¦ä¹ˆä¸€ç›´é˜»å¡çŸ¥é“è¢«å…¶ä»–çº¿ç¨‹å”¤é†’ã€‚</li></ol><h3 id="report"><a href="#report" class="headerlink" title="report"></a>report</h3><p>report å•æ‹‰å‡ºæ¥å§ï¼Œè¦ä¸ä»£ç å—å¤ªé•¿äº†</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> V <span class="token function">report</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> ExecutionException <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">//æ­£å¸¸æƒ…å†µä¸‹ï¼Œoutcome ä¿å­˜çš„æ˜¯callableè¿è¡Œç»“æŸçš„ç»“æœ</span>        <span class="token comment" spellcheck="true">//éæ­£å¸¸ï¼Œä¿å­˜çš„æ˜¯ callable æŠ›å‡ºçš„å¼‚å¸¸ã€‚</span>        Object x <span class="token operator">=</span> outcome<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æ¡ä»¶æˆç«‹ï¼šå½“å‰ä»»åŠ¡çŠ¶æ€æ­£å¸¸ç»“æŸ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> NORMAL<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// è¿”å› callable è¿ç®—ç»“æœ</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>V<span class="token punctuation">)</span>x<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// è¢«å–æ¶ˆçŠ¶æ€</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> CANCELLED<span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CancellationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ callable æ¥å£å®ç°ä¸­æœ‰ bug.</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Throwable<span class="token punctuation">)</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="finishCompletion"><a href="#finishCompletion" class="headerlink" title="finishCompletion()"></a>finishCompletion()</h3><p>æ ¹æ®å‰é¢çš„åˆ†æï¼Œä¸ç®¡æ˜¯ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸è¿˜æ˜¯ä»»åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼Œæˆ–è€…å–æ¶ˆä»»åŠ¡ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨finishCompletion()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®ç°å¦‚ä¸‹:</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finishCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// assert state > COMPLETING;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>WaitNode q<span class="token punctuation">;</span> <span class="token punctuation">(</span>q <span class="token operator">=</span> waiters<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> waitersOffset<span class="token punctuation">,</span> q<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//è·å–å½“å‰nodeèŠ‚ç‚¹å°è£…çš„ thread</span>                    Thread t <span class="token operator">=</span> q<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">//æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ä¸ä¸ºnull</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        q<span class="token punctuation">.</span>thread <span class="token operator">=</span> null<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//help GC</span>                          <span class="token comment" spellcheck="true">//å”¤é†’å½“å‰èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹</span>                        LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    WaitNode next <span class="token operator">=</span> q<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> null<span class="token punctuation">)</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    q<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// unlink to help gc</span>                    q <span class="token operator">=</span> next<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        callable <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// to reduce footprint</span>    <span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªæ–¹æ³•çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¾æ¬¡éå†waitersé“¾è¡¨ï¼Œå”¤é†’èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œç„¶åæŠŠcallableç½®ç©ºã€‚</p><p>è¢«å”¤é†’çš„çº¿ç¨‹ä¼šå„è‡ªä»awaitDone()æ–¹æ³•ä¸­çš„LockSupport.park*()é˜»å¡ä¸­è¿”å›ï¼Œç„¶åä¼šè¿›è¡Œæ–°ä¸€è½®çš„å¾ªç¯ã€‚åœ¨æ–°ä¸€è½®çš„å¾ªç¯ä¸­ä¼šè¿”å›æ‰§è¡Œç»“æœ(æˆ–è€…æ›´ç¡®åˆ‡çš„è¯´æ˜¯è¿”å›ä»»åŠ¡çš„çŠ¶æ€)ã€‚</p><h3 id="cancel"><a href="#cancel" class="headerlink" title="cancel"></a>cancel</h3><p>cancel() æ–¹æ³•ç”¨æ¥å–æ¶ˆå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚å¦‚æœå¼‚æ­¥ä»»åŠ¡å·²ç»å®Œæˆæˆ–è€…å·²ç»è¢«å–æ¶ˆï¼Œæˆ–è€…ç”±äºæŸäº›åŸå› ä¸èƒ½å–æ¶ˆï¼Œåˆ™ä¼šè¿”å›falseã€‚å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰è¢«æ‰§è¡Œï¼Œåˆ™ä¼šè¿”å› true å¹¶ä¸”å¼‚æ­¥ä»»åŠ¡ä¸ä¼šè¢«æ‰§è¡Œã€‚å¦‚æœä»»åŠ¡å·²ç»å¼€å§‹æ‰§è¡Œäº†ä½†æ˜¯è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œè‹¥ mayInterruptIfRunning ä¸º trueï¼Œåˆ™ä¼šç«‹å³ä¸­æ–­æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å¹¶è¿”å› trueï¼Œè‹¥ mayInterruptIfRunning ä¸º falseï¼Œåˆ™ä¼šè¿”å› true ä¸”ä¸ä¼šä¸­æ–­ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">//æ¡ä»¶ä¸€ï¼šstate == NEW æˆç«‹ è¡¨ç¤ºå½“å‰ä»»åŠ¡å¤„äºè¿è¡Œä¸­ æˆ–è€… å¤„äºçº¿ç¨‹æ±  ä»»åŠ¡é˜Ÿåˆ—ä¸­..</span>        <span class="token comment" spellcheck="true">//æ¡ä»¶äºŒï¼šæˆç«‹ï¼šè¯´æ˜ä¿®æ”¹çŠ¶æ€æˆåŠŸï¼Œå¯ä»¥å»æ‰§è¡Œä¸‹é¢é€»è¾‘äº†ï¼Œå¦åˆ™ è¿”å›false è¡¨ç¤ºcancelå¤±è´¥ã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>state <span class="token operator">==</span> NEW <span class="token operator">&amp;&amp;</span>              UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> NEW<span class="token punctuation">,</span>                  mayInterruptIfRunning <span class="token operator">?</span> INTERRUPTING <span class="token operator">:</span> CANCELLED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// in case call to interrupt throws exception</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mayInterruptIfRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// æ‰§è¡Œå½“å‰ FutureTask çš„çº¿ç¨‹ï¼Œæœ‰å¯èƒ½ç°åœ¨æ˜¯ nullï¼Œæ˜¯ null çš„æƒ…å†µï¼šå½“å‰ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ï¼Œè¿˜æ²¡æœ‰çº¿ç¨‹è·å–åˆ°å®ƒå‘¢ã€‚ã€‚</span>                    Thread t <span class="token operator">=</span> runner<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ runnerï¼Œæ­£åœ¨æ‰§è¡Œ task</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span>                          <span class="token comment" spellcheck="true">// ç»™runner çº¿ç¨‹ä¸€ä¸ªä¸­æ–­ä¿¡å·..</span>                        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// final state</span>                      <span class="token comment" spellcheck="true">// è®¾ç½®ä»»åŠ¡çŠ¶æ€ä¸º ä¸­æ–­å®Œæˆã€‚</span>                    UNSAFE<span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> INTERRUPTED<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å”¤é†’æ‰€æœ‰ get() é˜»å¡çš„çº¿ç¨‹</span>            <span class="token function">finishCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>æœ‰ä¸ªå€¼å¾—å…³æ³¨çš„é—®é¢˜å°±æ˜¯å½“ä»»åŠ¡è¿˜åœ¨æ‰§è¡Œçš„æ—¶å€™ç”¨æˆ·è°ƒç”¨cancel(true)æ–¹æ³•èƒ½å¦çœŸæ­£è®©ä»»åŠ¡åœæ­¢æ‰§è¡Œå‘¢ï¼Ÿ<br>åœ¨å‰é¢çš„åˆ†æä¸­æˆ‘ä»¬ç›´åˆ°ï¼Œå½“è°ƒç”¨cancel(true)æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…æ‰§è¡Œè¿˜æ˜¯Thread.interrupt()æ–¹æ³•ï¼Œè€Œinterrupt()æ–¹æ³•åªæ˜¯è®¾ç½®ä¸­æ–­æ ‡å¿—ä½ï¼Œå¦‚æœè¢«ä¸­æ–­çš„çº¿ç¨‹å¤„äºsleep()ã€wait()æˆ–è€…join()é€»è¾‘ä¸­åˆ™ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚</p><p>å› æ­¤ç»“è®ºæ˜¯:cancel(true)<strong>å¹¶ä¸ä¸€å®šèƒ½å¤Ÿåœæ­¢æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ã€‚</strong></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ€»ç»“ä¸‹ï¼Œå…¶å®FutureTaskçš„å®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå½“ç”¨æˆ·å®ç°Callable()æ¥å£å®šä¹‰å¥½ä»»åŠ¡ä¹‹åï¼ŒæŠŠä»»åŠ¡äº¤ç»™å…¶ä»–çº¿ç¨‹è¿›è¡Œæ‰§è¡Œã€‚FutureTaskå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªä»»åŠ¡çŠ¶æ€ï¼Œä»»ä½•æ“ä½œéƒ½æ˜¯å›´ç»•ç€è¿™ä¸ªçŠ¶æ€è¿›è¡Œï¼Œå¹¶éšæ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€ã€‚ä»»åŠ¡å‘èµ·è€…è°ƒç”¨get*()è·å–æ‰§è¡Œç»“æœçš„æ—¶å€™ï¼Œå¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™ä¼šæŠŠè‡ªå·±æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­ç„¶åè¿›è¡Œé˜»å¡ç­‰å¾…ã€‚å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ä¼šä¾æ¬¡å”¤é†’é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ã€‚è°ƒç”¨cancel()å–æ¶ˆä»»åŠ¡çš„æ—¶å€™ä¹Ÿåªæ˜¯ç®€å•çš„ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ï¼Œå¦‚æœéœ€è¦ä¸­æ–­ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹çš„è¯åˆ™è°ƒç”¨Thread.interrupt()ä¸­æ–­ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p>FutureTaskæºç è§£æâ€”linghu  <a href="https://www.cnblogs.com/linghu-java/p/8991824.html">https://www.cnblogs.com/linghu-java/p/8991824.html</a>     </p><p>B ç«™ â€å°åˆ˜è®²æºç â€œâ€“ã€Šç¡¬æ ¸æ‰‹æ’• Java çº¿ç¨‹æ±  FutureTask æºç ã€‹<a href="https://www.bilibili.com/video/BV13E411N7pp">https://www.bilibili.com/video/BV13E411N7pp</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥é“åœ¨ JAVA ä¸­ä¸€èˆ¬é€šè¿‡ç»§æ‰¿ Thread ç±»æˆ–è€…å®ç° Runnable æ¥å£ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºå¤šçº¿ç¨‹ã€‚ä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼æœ‰ä¸ªç¼ºé™·ï¼Œå°±æ˜¯ä¸èƒ½è·å–æ‰§è¡Œçš„ç»“æœã€‚å¦‚æœæƒ³è·å–ç»“æœéœ€è¦è¿ç”¨ Callable å’Œ Future æ¥å£æ¥è·å–ä»»åŠ¡ç»“æœã€‚ç”±äºæˆ‘æœ€è¿‘æƒ³çœ‹çº¿ç¨‹æ± æºç ï¼Œä»Šå¤©æˆ‘ä»¬æ¥</summary>
      
    
    
    
    <category term="çº¿ç¨‹" scheme="http://example.com/categories/%E7%BA%BF%E7%A8%8B/"/>
    
    
    <category term="Java" scheme="http://example.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ä¸»ä»å¤åˆ¶</title>
    <link href="http://example.com/2021/01/01/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
    <id>http://example.com/2021/01/01/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</id>
    <published>2021-01-01T13:28:45.000Z</published>
    <updated>2021-01-01T13:29:00.329Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶"><a href="#ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶"></a>ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶</h3><p>å°†ä¸€å° Redis ä¸»æœåŠ¡å™¨ä¸Šçš„æ•°æ®å¤åˆ¶åˆ°å…¶ä»–çš„ä»æœåŠ¡å™¨ä¸Šã€‚å‰è€…ç§°ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ï¼Œåè€…ç§°ä¸ºä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ï¼Œæ•°æ®çš„å¤åˆ¶æ—¶å•å‘çš„ï¼Œåªèƒ½ä»ä¸»èŠ‚ç‚¹å¤åˆ¶åˆ°ä»èŠ‚ç‚¹ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦ä¸»ä»å¤åˆ¶åŠŸèƒ½å‘¢ï¼Ÿ</p><p>1ï¼‰è¯»å†™åˆ†ç¦»</p><ul><li><p>è¯»æ“ä½œï¼šä¸»åº“ã€ä»åº“éƒ½å¯ä»¥æ¥å—ï¼›</p></li><li><p>å†™æ“ä½œï¼šé¦–å…ˆåˆ°ä¸»åº“æ‰§è¡Œï¼Œç„¶åä¸»åº“å°†å†™æ“ä½œåŒæ­¥ç»™ä»åº“</p></li></ul><p>â€‹       è¿™æ ·å¯ä»¥æå‡ Redis çš„æœåŠ¡èƒ½åŠ›ã€‚</p><p>2ï¼‰æ•°æ®å®¹ç¾</p><p>â€‹       ç”±äºä»æœåŠ¡å™¨ä¸ä¸»æœåŠ¡å™¨æ•°æ®ä¿æŒåŒæ­¥ï¼Œä¸€æ—¦ä¸»æœåŠ¡å™¨å®•æœºï¼Œå¯ä»¥ç«‹å³è¯·æ±‚åˆ‡æ¢åˆ°ä»æœåŠ¡å™¨ï¼Œä»è€Œé¿å… RedisæœåŠ¡ä¸­æ–­ã€‚</p><h4 id="ä¸»ä»åº“åŒæ­¥"><a href="#ä¸»ä»åº“åŒæ­¥" class="headerlink" title="ä¸»ä»åº“åŒæ­¥"></a>ä¸»ä»åº“åŒæ­¥</h4><p>æƒ³äº†è§£ä¸»ä»åº“ä¸€è‡´çš„é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¿˜è¦ä»ä¸»ä»åº“é—´ç¬¬ä¸€æ¬¡åŒæ­¥å…¥æ‰‹ã€‚</p><p>å½“æˆ‘ä»¬å¯åŠ¨å¤šä¸ª Redis å®ä¾‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <strong>replicaof</strong>ï¼ˆRedis 5.0 ä¹‹å‰ä½¿ç”¨ slaveofï¼‰å‘½ä»¤å½¢æˆä¸»åº“å’Œä»åº“çš„å…³ç³»ã€‚</p><p>ä¾‹å¦‚ï¼Œç°åœ¨æœ‰å®ä¾‹ 1ï¼ˆ172.16.19.3:6379ï¼‰å’Œ å®ä¾‹ 2ï¼ˆ172.16.19.5:7000ï¼‰ï¼Œæˆ‘ä»¬åœ¨å®ä¾‹ 2 ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åï¼Œå®ä¾‹ 2 å°±å˜æˆäº†å®ä¾‹ 1 çš„ä»åº“ï¼Œå¹¶ä»å®ä¾‹ 1 ä¸Šå¤åˆ¶æ•°æ®ã€‚</p><blockquote><p>172.16.19.5:7000&gt; REOLICAOF  172.16.19.3  6379</p><p>OK</p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å­¦ä¹ ä¸»ä»åº“é—´æ•°æ®ç¬¬ä¸€æ¬¡åŒæ­¥çš„ä¸‰ä¸ªé˜¶æ®µã€‚</p><img src="/images/redis/redis2/1.png">    <p><strong>ç¬¬ä¸€é˜¶æ®µ</strong>,æ˜¯ä¸»ä»åº“é—´å»ºç«‹è¿æ¥ã€åå•†åŒæ­¥çš„è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯ä¸ºå…¨é‡å¤åˆ¶åšå‡†å¤‡ã€‚åœ¨è¿™ä¸€æ­¥ï¼Œä»åº“å’Œä¸»åº“å»ºç«‹èµ·è¿æ¥ï¼Œå¹¶å‘Šè¯‰ä¸»åº“å³å°†è¿›è¡ŒåŒæ­¥ï¼Œä¸»åº“ç¡®è®¤å›å¤åï¼Œä¸»ä»åº“é—´å°±å¯ä»¥å¼€å§‹åŒæ­¥äº†ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œä»åº“ç»™ä¸»åº“å‘é€ psync å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œä¸»åº“æ ¹æ®è¿™ä¸ªå‘½ä»¤çš„å‚æ•°æ¥å¯åŠ¨å¤åˆ¶ã€‚psync å‘½ä»¤åŒ…å«äº†ä¸»åº“ runID å’Œå¤åˆ¶è¿›åº¦ offset ä¸¤ä¸ªå‚æ•°ã€‚</p><ul><li>runIDï¼Œæ˜¯æ¯ä¸ª Redis å®ä¾‹å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœº IDï¼Œç”¨æ¥å”¯ä¸€æ ‡è®°è¿™ä¸ªå®ä¾‹ã€‚å½“ä»åº“å’Œä¸»åº“ç¬¬ä¸€æ¬¡å¤åˆ¶æ—¶ï¼Œå› ä¸ºä¸çŸ¥é“ä¸»åº“çš„ runIDï¼Œæ‰€ä»¥å°† runID è®¾ä¸º â€œï¼Ÿâ€ã€‚</li><li>offsetï¼Œæ­¤æ—¶è®¾ç½®ä¸º -1ï¼Œè¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶ã€‚</li></ul><p><strong>ç¬¬äºŒé˜¶æ®µ</strong>  ï¼Œä¸»åº“å°†æ‰€æœ‰æ•°æ®åŒæ­¥ç»™ä»åº“ã€‚ä»åº“æ”¶åˆ°æ•°æ®åï¼Œåœ¨æœ¬åœ°å®Œæˆæ•°æ®åŠ è½½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾èµ–äºå†…å­˜å¿«ç…§ç”Ÿæˆçš„ RDB æ–‡ä»¶ã€‚</p><p><strong>ç¬¬ä¸‰ä¸ªé˜¶æ®µ</strong>ï¼Œä¸»åº“ä¼šæŠŠç¬¬äºŒé˜¶æ®µæ‰§è¡Œè¿‡ç¨‹ä¸­æ–°æ”¶åˆ°çš„å†™å‘½ä»¤ï¼Œå†å‘ç»™ä»åº“ã€‚å…·ä½“çš„æ“ä½œæ˜¯ï¼Œå½“ä¸»åº“å®Œæˆ RDB æ–‡ä»¶å‘é€åï¼Œå°±ä¼šæŠŠæ­¤æ—¶ replication buffer ä¸­çš„ä¿®æ”¹æ“ä½œå‘é€ç»™ä»åº“ï¼Œä»åº“å†é‡æ–°æ‰§è¡Œè¿™äº›æ“ä½œã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸»ä»åº“å°±å®ç°åŒæ­¥äº†ã€‚  </p><p>æ‰©å±•ä¸€ä¸‹ï¼Œä¸»åº“æ‰§è¡Œ bgsave å‘½ä»¤ï¼Œç”Ÿæˆ RDB æ–‡ä»¶ï¼Œæ¥ç€å°†æ–‡ä»¶å‘é€ç»™ä»åº“ã€‚ä½†æ˜¯è¿™ä¸ªæŒä¹…åŒ–æ“ä½œï¼ˆbgsaveï¼‰æ˜¯ä¸€ä¸ªéå¸¸æ¶ˆè€—èµ„æºçš„æ“ä½œï¼Œå¦‚æœä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¹‹é—´å‘ç”Ÿäº†æ—¶é—´è¾ƒçŸ­çš„ç½‘ç»œè¿æ¥æ•…éšœã€‚æ¢å¤åï¼Œä»æœåŠ¡å™¨ä¼šé‡æ–°è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼Œå¹¶å‘é€ sync å‘½ä»¤è¯·æ±‚åŒæ­¥æ•°æ®ã€‚è¿™æ—¶å€™ä¸»æœåŠ¡å™¨è¿˜éœ€è¦è¿›è¡Œå…¨é‡æŒä¹…åŒ–æ“ä½œå—ï¼Ÿæ˜¾ç„¶æ˜¯ä¸éœ€è¦ã€‚å› æ­¤åœ¨ Redis 2.8 æå‡ºäº†æ–°çš„ä¸»ä»å¤åˆ¶è§£å†³æ–¹æ¡ˆã€‚</p><ul><li>ä»æœåŠ¡å™¨ä¼šè®°å½•å·²ç»ä»ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ•°æ®é‡ï¼ˆå¤åˆ¶åç§»é‡ offsetï¼‰ã€‚</li><li>ä¸»æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ªå¤åˆ¶ç¼“å†²åŒºï¼Œè®°å½•è‡ªå·±å·²æ‰§è¡Œä¸”å¾…å‘é€ç»™ä»æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚ï¼ŒåŒæ—¶è¿˜éœ€è¦è®°å½•å¤åˆ¶ç¼“å†²åŒºèµ·ä¸€ä¸ªå­—èŠ‚çš„å¤åˆ¶åç§»é‡ã€‚</li></ul><p>å½“ä»æœåŠ¡å™¨è¿æ¥åˆ°ä¸»æœåŠ¡å™¨æ—¶ä¼šå‘é€ psync å‘½ä»¤è¯·æ±‚åŒæ­¥æ•°æ®ï¼Œä¸»æœåŠ¡å™¨åˆ¤æ–­è¯¥å¤åˆ¶åç§»é‡æ˜¯å¦è¿˜åŒ…å«åœ¨å¤åˆ¶ç¼“å†²åŒºï¼›å¦‚æœåŒ…å«ï¼Œåˆ™ä¸éœ€è¦æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œï¼Œç›´æ¥å‘ä»æœåŠ¡å™¨è¯·å‘é€å¤åˆ¶ç¼“å†²åŒºå‘½ä»¤è¯·æ±‚å³å¯ï¼Œè¿™ç§°ä¸ºéƒ¨åˆ†é‡åŒæ­¥ï¼›å¦‚æœä¸åŒ…å«ï¼Œåˆ™éœ€è¦æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œï¼ŒåŒæ—¶å°†æ‰€æœ‰æ–°æ‰§è¡Œçš„å†™å‘½ä»¤ç¼“å­˜åœ¨å¤åˆ¶ç¼“å†²åŒºä¸­ï¼Œå¹¶é‡ç½®å¤åˆ¶ç¼“å†²åŒºç¬¬ä¸€ä¸ªå­—èŠ‚çš„å¤åˆ¶åç§»é‡ï¼Œè¿™ç§°ä¸ºå®Œæ•´é‡åŒæ­¥ã€‚</p><h3 id="ä¸»-ä»-ä»-æ¨¡å¼"><a href="#ä¸»-ä»-ä»-æ¨¡å¼" class="headerlink" title="ä¸»-ä»-ä» æ¨¡å¼"></a>ä¸»-ä»-ä» æ¨¡å¼</h3><p>ä»ä¸Šæ–‡ä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ¬¡å…¨é‡å¤åˆ¶ä¸­ï¼Œå¯¹äºä¸»åº“æ¥è¯´ã€‚éœ€è¦å®Œæˆä¸¤ä¸ªè€—æ—¶çš„æ“ä½œï¼šç”ŸæˆRDBæ–‡ä»¶å’Œä¼ è¾“RDBæ–‡ä»¶ã€‚å¦‚æœä»åº“æ•°é‡å¾ˆå¤šï¼Œè€Œä¸”éƒ½è¦å’Œä¸»åº“è¿›è¡Œå…¨é‡å¤åˆ¶çš„è¯ï¼Œå°±ä¼šå¯¼è‡´ä¸»åº“å¿™äºforkå­è¿›ç¨‹ç”ŸæˆRDBæ–‡ä»¶ï¼Œè¿›è¡Œæ•°æ®å…¨é‡åŒæ­¥ã€‚forkè¿™ä¸ªæ“ä½œä¼šé˜»å¡ä¸»çº¿ç¨‹å¤„ç†æ­£å¸¸è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ä¸»åº“å“åº”åº”ç”¨ç¨‹åºçš„è¯·æ±‚é€Ÿåº¦å˜æ…¢ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡<strong>â€œä¸»- ä»-ä» æ¨¡å¼â€</strong>å°†ä¸»åº“ç”ŸæˆRDBå’Œä¼ è¾“RDBçš„å‹åŠ›ï¼Œä»¥çº§è”çš„æ–¹å¼åˆ†æ•£åˆ°æ•°æ®åº“ä¸Šã€‚</p><blockquote><p>replicaof   æ‰€é€‰ä»åº“çš„ IP  æ‰€é€‰ä»åº“çš„ç«¯å£å·</p></blockquote><p>å…¶å®è¯´ç™½äº†å°±æ˜¯ç»™ä»åº“é€‰æ‹©ä»åº“ï¼Œè¿™æ ·ä¸€æ¥è¿™äº›ä»åº“å°±ä¼šçŸ¥é“ï¼Œåœ¨è¿›è¡ŒåŒæ­¥æ—¶ï¼Œä¸ç”¨å†å’Œä¸»åº“è¿›è¡Œäº¤äº’äº†ï¼Œåªè¦å’Œçº§è”çš„ä»åº“è¿›è¡Œå†™æ“ä½œåŒæ­¥å°±è¡Œäº†ï¼Œè¿™æ ·å°±å¯ä»¥å‡è½»ä¸»åº“ä¸Šçš„å‹åŠ›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/images/redis/redis2/2.png" style="zoom:30%;">    <h3 id="ä¸»ä»åº“ä¹‹é—´ç½‘ç»œæ–­äº†æ€ä¹ˆåŠï¼Ÿ"><a href="#ä¸»ä»åº“ä¹‹é—´ç½‘ç»œæ–­äº†æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="ä¸»ä»åº“ä¹‹é—´ç½‘ç»œæ–­äº†æ€ä¹ˆåŠï¼Ÿ"></a><strong>ä¸»ä»åº“ä¹‹é—´ç½‘ç»œæ–­äº†æ€ä¹ˆåŠï¼Ÿ</strong></h3><p>åœ¨Redis2.8ä¹‹å‰ã€‚å¦‚æœä¸»åº“åœ¨å‘½ä»¤ä¼ æ’­æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­ï¼Œé‚£ä¹ˆä»åº“ä¼šå’Œä¸»åº“è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œå¼€é”€å¾ˆå¤§ã€‚</p><p>ä»Redis2.8å¼€å§‹ï¼Œç½‘ç»œæ–­äº†ä¹‹åï¼Œä¸»ä»åº“ä¼šé‡‡å–ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼ç»§ç»­åŒæ­¥ï¼Œå¢é‡å¤åˆ¶åªä¼šæŠŠä¸»ä»ç½‘ç»œæ–­è¿æœŸé—´ä¸»åº“æ”¶åˆ°çš„å‘½ä»¤åŒæ­¥ç»™ä»åº“ã€‚</p><p>å½“ä¸»ä»åº“æ–­è¿åï¼Œä¸»åº“ä¼šæŠŠæ–­è¿æœŸé—´æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼Œå†™å…¥ replication bufferï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›å†™æ“ä½œå‘½ä»¤ä¹Ÿå†™å…¥ repl_backlog_bufferè¿™ä¸ªç¼“å†²åŒºã€‚repl_backlog_bufferæ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œä¸»åº“ä¼šè®°å½•è‡ªå·±å†™åˆ°çš„ä½ç½®ï¼Œä»åº“åˆ™ä¼šè®°å½•è‡ªå·±å·²ç»è¯»åˆ°çš„ä½ç½®ã€‚</p><p>åˆšå¼€å§‹çš„æ—¶å€™ï¼Œä¸»åº“å’Œä»åº“çš„å†™è¯»ä½ç½®åœ¨ä¸€èµ·ï¼Œè¿™ç®—ä»–ä»¬çš„èµ·å§‹ä½ç½®ã€‚éšç€ä¸»åº“ä¸æ–­æ¥å—æ–°çš„å†™æ“ä½œï¼Œä»–åœ¨ç¼“å†²åŒºä¸­çš„å†™ä½ç½®ä¼šé€æ­¥åç¦»èµ·å§‹ä½ç½®ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨åç§»é‡æ¥è¡¡é‡è¿™ä¸ªåç§»è·ç¦»çš„å¤§å°ï¼Œå¯¹ä¸»åº“æ¥è¯´å¯¹åº”çš„åç§»é‡å°±æ˜¯master_repl_offsetã€‚ä¸»åº“æ¥å—çš„æ–°å†™æ“ä½œè¶Šå¤šï¼Œè¿™ä¸ªå€¼å°±ä¼šè¶Šå¤§ã€‚<br>åŒæ ·ï¼Œä»åº“åœ¨å¤åˆ¶å®Œå†™æ“ä½œå‘½ä»¤åï¼Œä»–åœ¨ç¼“å†²åŒºçš„è¯»ä½ç½®ä¹Ÿå¼€å§‹é€æ¸åç§»åˆšæ‰çš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶ï¼Œä»åº“å·²å¤åˆ¶çš„åç§»é‡slave_repl_offsetä¹Ÿåœ¨ä¸æ–­å¢åŠ ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªåç§»é‡åŸºæœ¬ç›¸ç­‰ã€‚</p><img src="/images/redis/redis2/3.png" style="zoom:50%;">    <p>ä¸»ä»åº“çš„è¿æ¥æ¢å¤ä¹‹åï¼Œä»åº“é¦–å…ˆä¼šç»™ä¸»åº“å‘é€psyncå‘½ä»¤ï¼Œå¹¶æŠŠè‡ªå·±å½“å‰çš„slave_repl_offsetå‘ç»™ä¸»åº“ï¼Œä¸»åº“ä¼šåˆ¤æ–­è‡ªå·±çš„master_repl_offsetå‘ç»™ä¸»åº“ï¼Œä¸»åº“ä¼šåˆ¤æ–­è‡ªå·±çš„master_repl_offsetå’Œslave_repl_offsetä¹‹é—´çš„å·®è·ã€‚</p><p>åœ¨ç½‘ç»œæ–­è¿é˜¶æ®µï¼Œä¸»åº“å¯èƒ½ä¼šæ”¶åˆ°æ–°çš„å†™æ“ä½œå‘½ä»¤ï¼Œæ‰€ä»¥ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œmaster_repl_offsetä¼šå¤§äºslave_repl_offsetå’Œmaster_repl_offsetä¹‹é—´çš„å‘½ä»¤æ“ä½œåŒæ­¥ç»™ä»åº“å°±è¡Œã€‚</p><p>ä¸è¿‡ï¼Œè¿˜æœ‰ä¸ªåœ°æ–¹éœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œå› ä¸ºrepl_backlog_bufferæ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ‰€ä»¥åœ¨ç¼“å†²åŒºå†™æ»¡åï¼Œä¸»åº“ä¼šç»§ç»­å†™å…¥ï¼Œæ­¤æ—¶ï¼Œå°±ä¼šè¦†ç›–æ‰ä¹‹å‰å†™å…¥çš„æ“ä½œã€‚å¦‚æœä»åº“çš„è¯»å–é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä»åº“è¿˜æ²¡è¯»å–çš„æ“ä½œè¢«ä¸»åº“æ–°çš„å†™æ“ä½œè¦†ç›–äº†ï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸»ä»åº“é—´çš„æ•°æ®ä¸ä¸€è‡´ã€‚å› æ­¤æˆ‘ä»¬è¦æƒ³åŠæ³•é¿å…è¿™ä¸€æƒ…å†µï¼Œä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒæ•´repl_bacjlog_sizeè¿™ä¸ªå‚æ•°ã€‚è¿™ä¸ªå‚æ•°å’Œæ‰€éœ€çš„ç¼“å†²ç©ºé—´å¤§å°æœ‰å…³ã€‚ç¼“å†²ç©ºé—´çš„è®¡ç®—å…¬å¼æ˜¯ï¼š<strong>ç¼“å†²ç©ºé—´å¤§å°=ä¸»åº“å†™å…¥å‘½ä»¤é€Ÿåº¦ * æ“ä½œå¤§å°-ä¸»ä»åº“é—´ç½‘ç»œä¼ è¾“å‘½ä»¤é€Ÿåº¦ * æ“ä½œå¤§å°</strong>ã€‚å†å®é™…åº”ç”¨ä¸­ï¼Œè€ƒè™‘åˆ°å¯èƒ½å­˜åœ¨ä¸€äº›çªå‘è¯·æ±‚å‹åŠ›ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦æŠŠè¿™ä¸ªç¼“å†²ç©ºé—´æ‰©å¤§ä¸€å€ï¼Œå³ <u>repl_backlog_size = ç¼“å†²ç©ºé—´å¤§å° * 2</u>ï¼Œè¿™ä¹Ÿå°±æ˜¯repl_bavklog_sizeçš„æœ€ç»ˆå€¼ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸»åº“æ¯ç§’å†™å…¥ 2000 ä¸ªæ“ä½œï¼Œæ¯ä¸ªæ“ä½œçš„å¤§å°ä¸º 2KBï¼Œç½‘ç»œæ¯ç§’èƒ½ä¼ è¾“ 1000 æ“ä½œï¼Œé‚£ä¹ˆï¼Œæœ‰ 1000 ä¸ªæ“ä½œéœ€è¦ç¼“å†²èµ·æ¥ï¼Œè¿™å°±è‡³å°‘éœ€è¦ 2MB çš„ç¼“å†²ç©ºé—´ã€‚å¦åˆ™ï¼Œæ–°å†™çš„å‘½ä»¤å°±ä¼šè¦†ç›–åˆ°æ—§æ“ä½œäº†ã€‚ä¸ºäº†åº”ä»˜å¯èƒ½çš„çªå‘å‹åŠ›ï¼Œæˆ‘ä»¬æœ€ç»ˆæŠŠ repl_backlog_size è®¾ä¸º 4MBã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ¬ç¯‡ä¸»è¦è®²è§£äº†ä¸»ä»å¤åˆ¶çš„æ¦‚å¿µä¸åŸç†ï¼Œè¿˜å¼•å…¥â€œä¸»-ä»-ä»â€çš„æ¦‚å¿µå’Œæ–­ç½‘å Redis å¦‚ä½•æ“ä½œã€‚ç›¸ä¿¡å¤§å®¶å¯¹ä¸»ä»å¤åˆ¶æœ‰å¯è¾ƒæ·±çš„å°è±¡ï¼Œæ¥ä¸‹æ¥ä¼šç»§ç»­è¡¥å……å’Œæ”¶é›†å…³äºä¸€è‡´æ€§ã€å“¨å…µå’Œé›†ç¾¤ç­‰æ–¹é¢çš„çŸ¥è¯†ï¼Œå¸Œæœ›å¤§å®¶èƒ½å¤Ÿå–œæ¬¢ã€‚å¦‚æœåç»­æœ‰æ—¶é—´æˆ–è€…éœ€è¦æˆ‘ä¼šå°†ä¸»ä»çš„æºç è¡¥å……ã€‚</p><p>ç¥å¤§å®¶ 2021 æ–°å¹´å¿«ä¹ï¼ï¼</p><p>æœ€åæ–‡ç« çš„èµ„æ–™æ¥æºï¼š</p><p>â€‹                                                                                                                            æå®¢æ—¶é—´â€”-ã€ŠRedis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ã€‹</p><p>â€‹                                                                                                                    ã€ŠRedis 5è®¾è®¡ä¸æºç åˆ†æã€‹â€”- é™ˆé›· ç­‰ç¼–è‘—</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶&lt;/h3&gt;&lt;p&gt;å°†ä¸€å° Redis ä¸»æœåŠ¡å™¨ä¸Šçš„æ•°æ®å¤åˆ¶åˆ°å…¶ä»–çš„ä»æœåŠ¡å™¨ä¸Šã€‚å‰è€…ç§°ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ï¼Œåè€…ç§°ä¸º</summary>
      
    
    
    
    <category term="Redis" scheme="http://example.com/categories/Redis/"/>
    
    
    <category term="æ•°æ®åº“" scheme="http://example.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>é¢è¯•é¢˜</title>
    <link href="http://example.com/2020/12/29/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <id>http://example.com/2020/12/29/%E9%9D%A2%E8%AF%95%E9%A2%98/</id>
    <published>2020-12-28T21:34:42.000Z</published>
    <updated>2021-01-06T03:22:44.166Z</updated>
    
    <content type="html"><![CDATA[<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=472137696&auto=1&height=66"></iframe><h3 id="1-Spring-äº‹åŠ¡ï¼ˆ20201229ï¼‰"><a href="#1-Spring-äº‹åŠ¡ï¼ˆ20201229ï¼‰" class="headerlink" title="1. Spring äº‹åŠ¡ï¼ˆ20201229ï¼‰"></a>1. Spring äº‹åŠ¡ï¼ˆ20201229ï¼‰</h3><h4 id="1-1-Spring-äº‹åŠ¡ä¸­çš„éš”ç¦»çº§åˆ«æœ‰å“ªå‡ ç§ï¼Ÿ"><a href="#1-1-Spring-äº‹åŠ¡ä¸­çš„éš”ç¦»çº§åˆ«æœ‰å“ªå‡ ç§ï¼Ÿ" class="headerlink" title="1.1 Spring äº‹åŠ¡ä¸­çš„éš”ç¦»çº§åˆ«æœ‰å“ªå‡ ç§ï¼Ÿ"></a>1.1 Spring äº‹åŠ¡ä¸­çš„éš”ç¦»çº§åˆ«æœ‰å“ªå‡ ç§ï¼Ÿ</h4><ul><li>TransactionDefinition.ISOLATION_DEFAULTï¼šä½¿ç”¨åç«¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼ŒMysql é»˜è®¤é‡‡ç”¨ REPEATABLE_READ éš”ç¦»çº§åˆ«ï¼ŒOracle é»˜è®¤é‡‡ç”¨çš„ READ_COMMITTED éš”ç¦»çº§åˆ«ã€‚</li><li>TransactionDefinition.ISOLATION_READ_UNCOMMITTEDï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€æ¬¢åº¦æˆ–ä¸å¯é‡å¤è¯»</li><li>TransactionDefinition.ISOLATION_READ_COMMITTEDï¼šå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤åº¦ä»å¯èƒ½å‘ç”Ÿ</li><li>TransactionDefinition.ISOLATION_REPEATABLE_READï¼šå¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li><li>TransactionDefinition.ISOLATION_SERIALIZABLEï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹ç‰©ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ä½†æ˜¯è¿™æ ·å°†ä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ä¹Ÿä¸ä¼šç”¨åˆ°è¯¥çº§åˆ«ã€‚</li></ul><h4 id="1-2-Spring-äº‹åŠ¡ä¼ æ’­æœºåˆ¶ç±»å‹"><a href="#1-2-Spring-äº‹åŠ¡ä¼ æ’­æœºåˆ¶ç±»å‹" class="headerlink" title="1.2 Spring äº‹åŠ¡ä¼ æ’­æœºåˆ¶ç±»å‹"></a>1.2 Spring äº‹åŠ¡ä¼ æ’­æœºåˆ¶ç±»å‹</h4><p>â‘  PROPAGATION_REQUIRED</p><ul><li>æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æ–°å»ºäº‹åŠ¡</li><li>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œåˆå¹¶æˆä¸€ä¸ªäº‹åŠ¡</li></ul><p>â‘¡ REQUIRES_NEW</p><ul><li>æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·</li><li>ä¸å—è°ƒç”¨è€…çš„äº‹ç‰©å½±å“ï¼Œçˆ¶çº§å¼‚å¸¸ï¼Œå®ƒä¹Ÿæ˜¯æ­£å¸¸æäº¤</li></ul><p>â‘¢ SUPPORTS</p><ul><li>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥äº‹åŠ¡</li><li>ä¸å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ</li></ul><p>â‘£ NOT_SUPPORTED</p><ul><li>ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ</li><li>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·</li></ul><p>â‘¤ MANDATORY</p><ul><li>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™è¿è¡Œåœ¨å½“å‰äº‹åŠ¡ä¸­</li><li>å¦‚æœå½“å‰æ— äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå³çˆ¶çº§æ–¹æ³•å¿…é¡»æœ‰äº‹åŠ¡</li></ul><p>â‘¥ NEVER</p><ul><li>ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå³çˆ¶çº§æ–¹æ³•å¿…é¡»æ— äº‹åŠ¡</li></ul><p>â‘¦ NESTED</p><ul><li><p>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œä»–ä¼šå°†æˆä¸ºçˆ¶çº§äº‹ç‰©çš„ä¸€ä¸ªå­äº‹åŠ¡ï¼Œæ–¹æ³•ç»“æŸåå¹¶æ²¡æœ‰æäº¤ï¼Œåªæœ‰ç­‰çˆ¶äº‹åŠ¡ç»“æŸäº†æ‰æäº¤</p></li><li><p>å¦‚æœå½“å‰æ²¡äº‹åŠ¡ï¼Œåˆ™æ–°å»ºäº‹åŠ¡</p></li><li><p>å¦‚æœå®ƒå¼‚å¸¸ï¼Œçˆ¶çº§å¯ä»¥æ•è·å®ƒçš„å¼‚å¸¸è€Œä¸è¿›è¡Œæ··æ»šï¼Œæ­£å¸¸æäº¤</p></li></ul><p>å‚è€ƒï¼š<a href="https://segmentfault.com/a/1190000020386113?utm_source=tag-newest">https://segmentfault.com/a/1190000020386113?utm_source=tag-newest</a></p><h3 id="2-TCP-å’Œ-UDP-çš„åŒºåˆ«"><a href="#2-TCP-å’Œ-UDP-çš„åŒºåˆ«" class="headerlink" title="2. TCP å’Œ UDP çš„åŒºåˆ«"></a>2. TCP å’Œ UDP çš„åŒºåˆ«</h3><p>UDP åœ¨ä¼ è¾“æ•°æ®ä¹‹å‰ä¸éœ€è¦å…ˆå»ºç«‹è¿æ¥ï¼Œè¿œåœ°ä¸»æœºåœ¨æ”¶åˆ° UDP æŠ¥æ–‡åï¼Œä¸éœ€è¦ç»™å‡ºä»»ä½•ç¡®è®¤ã€‚è™½ç„¶UDP ä¸æä¾›å¯é äº¤ä»˜ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ UDP ç¡®æ˜¯ä¸€ç§æœ€æœ‰æ•ˆçš„å·¥ä½œæ–¹å¼ï¼ˆä¸€èˆ¬ç”¨äºå³æ—¶é€šä¿¡ï¼‰ï¼Œæ¯”å¦‚ï¼šQQ è¯­éŸ³ã€QQ è§†é¢‘ã€ç›´æ’­ç­‰ç­‰ã€‚</p><p>TCP æä¾›é¢å‘è¿æ¥çš„æœåŠ¡ã€‚åœ¨ä¼ é€æ•°æ®ä¹‹å‰å¿…é¡»å…ˆå»ºç«‹è¿æ¥ï¼Œæ•°æ®ä¼ é€ç»“æŸåè¦é‡Šæ”¾è¿æ¥ã€‚TCP ä¸æä¾›å¹¿æ’­æˆ–å¤šæ’­æœåŠ¡ã€‚ç”±äº TCP è¦æä¾›å¯é çš„ï¼Œé¢å‘è¿æ¥çš„ä¼ è¾“æœåŠ¡ï¼ˆTCP çš„å¯é ä½“ç°åœ¨ TCP åœ¨ä¼ é€’æ•°æ®ä¹‹å‰ï¼Œä¼šæœ‰ä¸‰æ¬¡æ¡æ‰‹æ¥å»ºç«‹è¿æ¥ï¼Œè€Œä¸”åœ¨æ•°æ®ä¼ é€’æ—¶ï¼Œæœ‰ç¡®è®¤ã€çª—å£ã€é‡ä¼ ã€æ‹¥å¡æ§åˆ¶ï¼Œåœ¨æ•°æ®ä¼ å®Œåï¼Œè¿˜ä¼šæ–­å¼€è¿æ¥æ¥èŠ‚çº¦ç³»ç»Ÿèµ„æºï¼‰ï¼Œè¿™ä¸€éš¾ä»¥é¿å…å¢åŠ äº†è®¸å¤šå¼€é”€ï¼Œå¦‚ç¡®è®¤ï¼Œæµé‡æ§åˆ¶ï¼Œè®¡æ—¶å™¨ä»¥åŠè¿æ¥ç®¡ç†ç­‰ã€‚è¿™ä¸ä»…ä½¿åè®®æ•°æ®å•å…ƒçš„é¦–éƒ¨å¢å¤§å¾ˆå¤šï¼Œè¿˜è¦å ç”¨è®¸å¤šå¤„ç†æœºèµ„æºã€‚TCP ä¸€èˆ¬ç”¨äºæ–‡ä»¶ä¼ è¾“ã€å‘é€å’Œæ¥æ”¶é‚®ä»¶ã€è¿œç¨‹ç™»å½•ç­‰åœºæ™¯ ã€‚</p><h3 id="3-HTTP-ä¸-HTTPS-çš„åŒºåˆ«"><a href="#3-HTTP-ä¸-HTTPS-çš„åŒºåˆ«" class="headerlink" title="3. HTTP ä¸ HTTPS çš„åŒºåˆ«"></a>3. HTTP ä¸ HTTPS çš„åŒºåˆ«</h3><ol><li>ç«¯å£ï¼šHTTP çš„ URL ç”± â€œhttp://â€ å…¶å®ä¸”é»˜è®¤ä½¿ç”¨ç«¯å£ 80ï¼Œè€Œ HTTPS çš„ URL ç”±â€œhttps://â€ èµ·å§‹ä¸”é»˜è®¤ä½¿ç”¨ç«¯å£ 443ã€‚</li><li>å®‰å…¨æ€§å’Œèµ„æºæ¶ˆè€—ï¼š HTTP åè®®è¿è¡Œåœ¨ TCP ä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“å†…å®¹éƒ½æ˜¯æ˜æ–‡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½æ˜¯æ— æ³•éªŒè¯å¯¹æ–¹èº«ä»½ã€‚HTTPS æ˜¯è¿è¡Œåœ¨ SSL/TLS ä¹‹ä¸Šçš„ HTTP åè®®ï¼ŒSSL/TLS è¿è¡Œåœ¨ TCP ä¹‹ä¸Šã€‚æ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½æ˜¯ç»è¿‡åŠ å¯†ï¼ŒåŠ å¯†é‡‡ç”¨å¯¹ç§°åŠ å¯†ï¼Œä½†å¯¹ç§°åŠ å¯†çš„å¯†é’¥ç”¨æœåŠ¡å™¨æ–¹çš„è¯ä¹¦è¿›è¡Œéå¯¹ç§°åŠ å¯†ã€‚æ‰€ä»¥è¯´ï¼ŒHTTP å®‰å…¨æ€§æ²¡æœ‰ HTTPS é«˜ï¼Œä½†æ˜¯ HTTPS æ¯” HTTPè€—è´¹æ›´å¤šæœåŠ¡å™¨èµ„æºã€‚</li></ol><h3 id="4-Redis-çš„è¿‡æœŸæ·˜æ±°ç­–ç•¥"><a href="#4-Redis-çš„è¿‡æœŸæ·˜æ±°ç­–ç•¥" class="headerlink" title="4. Redis çš„è¿‡æœŸæ·˜æ±°ç­–ç•¥"></a>4. Redis çš„è¿‡æœŸæ·˜æ±°ç­–ç•¥</h3><p>1ï¼‰å…¨å±€çš„é”®ç©ºé—´é€‰æ‹©æ€§ç§»é™¤</p><ul><li>noevictionï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚</li><li>llkey-lruï¼šåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyã€‚</li><li>llkey-randomï¼šåœ¨é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ª keyã€‚</li></ul><p>2ï¼‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´é€‰æ‹©æ€§ç§»é™¤</p><ul><li>volatile-lruï¼šåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ key</li><li>olatile-randomï¼šåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ª key</li><li>volatile-ttlï¼šåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œæœ‰æ›´æ—©è¿‡æœŸæ—¶é—´çš„ key ä¼˜å…ˆç§»é™¤</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;iframe frameborder=&quot;no&quot; border=&quot;0&quot; marginwidth=&quot;0&quot; marginheight=&quot;0&quot; width=&quot;330&quot; height=&quot;86&quot; src=&quot;//music.163.com/outchain/player?type=2&amp;id=</summary>
      
    
    
    
    <category term="é¢è¯•é¢˜" scheme="http://example.com/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
    
    <category term="é¢è¯•é¢˜" scheme="http://example.com/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>Redis æŒä¹…åŒ–</title>
    <link href="http://example.com/2020/12/26/redis%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <id>http://example.com/2020/12/26/redis%E6%8C%81%E4%B9%85%E5%8C%96/</id>
    <published>2020-12-26T03:12:25.000Z</published>
    <updated>2020-12-26T09:11:57.467Z</updated>
    
    <content type="html"><![CDATA[<p>ä»æ‰€å‘¨çŸ¥ï¼ŒRedis çš„æ•°æ®å…¨éƒ¨æ”¾åœ¨å†…å­˜é‡Œï¼Œå¦‚æœçªç„¶å®•æœºï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œå› æ­¤å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶æ¥ä¿è¯ Redis çš„æ•°æ®ä¸ä¼šå› ä¸ºæ•…éšœè€Œä¸¢å¤±ï¼Œè¿™ç§æœºåˆ¶å°±æ˜¯ <strong>Redis çš„æŒä¹…åŒ–æœºåˆ¶</strong>ã€‚</p><p>Redis æœ‰ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼šä¸€ç§ä¸º <strong>RDB æ–¹å¼</strong>ï¼ŒRDB ä¿å­˜æŸä¸€ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„æ•°æ®ï¼›å¦ä¸€ç§ä¸º <strong>AFO æ–¹å¼</strong>ï¼ŒAOFä¿å­˜çš„æ˜¯ Redis æœåŠ¡å™¨ç«¯æ‰§è¡Œçš„æ¯ä¸€æ¡å‘½ä»¤ã€‚</p><h3 id="å¿«ç…§-RDB"><a href="#å¿«ç…§-RDB" class="headerlink" title="å¿«ç…§ RDB"></a>å¿«ç…§ RDB</h3><p>RDB å¿«ç…§æœ‰ä¸¤ç§è§¦å‘æ–¹å¼ï¼Œå…¶ä¸€<strong>é€šè¿‡é…ç½®å‚æ•°</strong>ï¼Œä¾‹å¦‚åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å…¥å¦‚ä¸‹é…ç½®ï¼š</p><blockquote><p>save  60  1000</p></blockquote><p>åœ¨ 60 ç§’å†…å¦‚æœæœ‰ 1000 ä¸ª key å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡ RDB å¿«ç…§çš„æ‰§è¡Œã€‚</p><p>å…¶äºŒæ˜¯<strong>é€šè¿‡åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ bgsave å‘½ä»¤</strong> æ˜¾å¼è§¦å‘ä¸€æ¬¡ RDB å¿«ç…§æ‰§è¡Œã€‚ï¼ˆä¸‹å›¾ä¸º bgsave çš„æ‰§è¡Œæµç¨‹ï¼‰                </p><img src="/images/redis/redis1/r1.png" style="zoom:30%;">                        <blockquote><p>SAVE  å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨äºç”Ÿæˆ RDB æ–‡ä»¶ï¼Œä¸åŒçš„æ˜¯ SASVE ä¼šé˜»å¡ Redis æœåŠ¡å™¨è¿›ç¨‹ï¼Œç›´è‡³ RDB æ–‡ä»¶åˆ›å»ºå®Œæ¯•</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å…³æ³¨çš„é—®é¢˜æ˜¯ï¼Œåœ¨å†…å­˜æ•°æ®åšå¿«ç…§æ—¶ï¼Œè¿™äº›æ•°æ®è¿˜èƒ½è¢«ä¿®æ”¹å—ï¼Ÿå¦‚æœæˆ‘ä»¬åœ¨æ‹ç…§ç‰‡æ—¶è¢«æ‹å¯¹è±¡â€åŠ¨â€œäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹åˆ°çš„ç…§ç‰‡æ˜¯æ¨¡ç³Šçš„ã€‚å‡å¦‚ä¸€æ¬¡å¿«ç…§æ—¶é—´æ˜¯ 20sï¼Œåœ¨æ—¶åˆ» t ç»™å†…å­˜åšå¿«ç…§ã€‚è€Œåœ¨æ—¶åˆ» t + 5 æ—¶ï¼Œä¸€ä¸ªè¿˜æ²¡è¢«å†™å…¥ç£ç›˜çš„å†…å­˜æ•°æ® A è¢«ä¿®æ”¹ä¸º Bï¼Œé‚£ä¹ˆå°±ç ´åäº†å¿«ç…§çš„å®Œæ•´æ€§ï¼Œå› ä¸º B ä¸æ˜¯ t æ—¶åˆ»çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œå’Œæ‹ç…§ç±»ä¼¼ï¼Œæˆ‘ä»¬åœ¨åšå¿«ç…§æ—¶ä¸å¸Œæœ›æ•°æ® â€åŠ¨â€œï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è¢«ä¿®æ”¹ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯æ˜¯å¦‚æœåœ¨å¿«ç…§çš„æ—¶é—´é‡Œï¼ŒRedis ä¸èƒ½å¤„ç†è¿™äº›æ•°æ®çš„å†™æ“ä½œï¼Œé‚£ä¹ˆæ— ç–‘ä¼šç»™ä¸šåŠ¡æœåŠ¡é€ æˆå·¨å¤§çš„å½±å“ï¼Œè‚¯å®šæ˜¯ä¸èƒ½æ¥å—çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼ŒRedis å°±ä¼šå¦‚ä¸Šå›¾æ‰€ç¤º fork å‡ºä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œ rdbSave å‡½æ•°è¿›è¡Œå®é™…çš„å¿«ç…§å­˜å‚¨å·¥ä½œã€‚å…¶åŸç†æ˜¯å€ŸåŠ©æ“ä½œç³»ç»Ÿæä¾›çš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ ï¼ˆCopy On Writeï¼‰ï¼Œåœ¨æ‰§è¡Œå¿«ç…§çš„åŒæ—¶ï¼Œæ­£å¸¸å¤„ç†å†™æ“ä½œã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç®€å•æ¥è¯´ï¼Œbgsave å­è¿›ç¨‹æ˜¯ç”±ä¸»çº¿ç¨‹ fork ç”Ÿæˆçš„ï¼Œå¯ä»¥å…±äº«ä¸»çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜æ•°æ®ã€‚bgsave å­è¿›ç¨‹è¿è¡Œåï¼Œå¼€å§‹è¯»å–ä¸»çº¿ç¨‹çš„å†…å­˜æ•°æ®ï¼Œå¹¶æŠŠå®ƒä»¬å†™å…¥ RDB æ–‡ä»¶ã€‚æ­¤æ—¶ï¼Œå¦‚æœä¸»çº¿ç¨‹å¯¹è¿™äº›æ•°æ®ä¹Ÿéƒ½æ˜¯è¯»æ“ä½œï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹å’Œ bgsave å­è¿›ç¨‹ç›¸äº’ä¸å½±å“ã€‚ä½†æ˜¯å¦‚æœä¸»çº¿ç¨‹è¦ä¿®æ”¹ä¸€å—æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ COW æœºåˆ¶æ¥è¿›è¡Œæ•°æ®æ®µé¡µé¢çš„åˆ†ç¦»ã€‚æ•°æ®æ®µæ˜¯ç”±å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„é¡µé¢ç»„åˆè€Œæˆï¼Œå½“çˆ¶è¿›ç¨‹å¯¹å…¶ä¸­ä¸€ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šå°†è¢«å…±äº«çš„é¡µé¢å¤åˆ¶ä¸€ä»½åˆ†ç¦»å¼€æ¥ï¼Œç„¶åå¯¹è¿™ä¸ªå¤åˆ¶çš„é¡µé¢è¿›è¡Œä¿®æ”¹ã€‚è¿™æ—¶å­è¿›ç¨‹ç›¸åº”çš„é¡µé¢æ—¶æ²¡æœ‰å˜åŒ–çš„ï¼Œè¿˜æ˜¯è¿›ç¨‹äº§ç”Ÿçš„é‚£ä¸€ç¬é—´çš„æ•°æ®ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RDB ä¿å­˜çš„æ˜¯ä¸€ä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§ï¼Œé‚£ä¹ˆå¦‚æœ Redis å‡ºç°äº†æ•…éšœï¼Œä¸¢å¤±çš„å°±æ˜¯æœ€åä¸€æ¬¡ RDB æ‰§è¡Œçš„æ—¶é—´ç‚¹åˆ°æ•…éšœå‘ç”Ÿçš„æ—¶é—´é—´éš”ä¹‹å†…ä¹‹å†…äº§ç”Ÿçš„æ•°æ®ã€‚å¦‚æœ Redis æ•°æ®é‡å¾ˆå¤§ï¼ŒQPS å¾ˆé«˜ï¼Œé‚£ä¹ˆæ•…éšœå‘ç”Ÿæ—¶ä¸¢å¤±çš„æ•°æ®ä¹Ÿä¼šå¢å¤šã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªç”± RDB æœ¬è´¨å¼•å‘çš„é—®é¢˜å‘¢ï¼Ÿè¯·å¾€ä¸‹çœ‹ã€‚</p><h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AOF å°±æ˜¯å°† Redis æœåŠ¡ç«¯æ‰§è¡Œè¿‡çš„æ¯ä¸€æ¡å‘½ä»¤éƒ½ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å½“Redis é‡å¯æ—¶åªè¦æŒ‰ç…§é¡ºåºå›æ”¾è¿™äº›å‘½ä»¤å°±ä¼šæ¢å¤åˆ°åŸå§‹çŠ¶æ€ã€‚è€Œ AOF ä¿å­˜çš„æ˜¯ä¸€æ¡æ¡å‘½ä»¤ï¼Œç†è®ºä¸Šå¯ä»¥åšåˆ°å‘ç”Ÿæ•…éšœæ—¶åªä¸¢å¤±ä¸€æ¡å‘½ä»¤ã€‚é‚£ä¹ˆå¦‚ä½•å¼€å¯ AOF å‘¢ï¼Ÿ</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆæˆ‘ä»¬è¦ä¿®æ”¹ Redis çš„é…ç½®æ–‡ä»¶ <strong>redis.conf</strong>ï¼Œæ‰¾åˆ° <strong>appendonly</strong>ï¼Œå°†è¯¥å€¼çš„ no è¯¥å†™ä¸º yesã€‚é€€å‡ºåé‡å¯ Redisï¼Œå°±ä¼šå‘ç° Redis bin ç›®å½•ä¸‹æœ‰ä¸€ä¸ª appendonly.aof æ–‡ä»¶ï¼Œè¯æ˜ AOF æŒä¹…åŒ–å¼€å¯æˆåŠŸã€‚</p><p><strong>AOF æ—¥å¿—æ˜¯ç”±ä¸»çº¿ç¨‹æ¥å®Œæˆçš„ã€‚</strong></p><p>ä¸‹å›¾ä¸º AOF  æŒä¹…åŒ–çš„è¿‡ç¨‹ã€‚</p><img src="/images/redis/redis1/aof1.png" style="zoom:50%;">    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ aof_buf ç¼“å†²åŒºçš„æœ«å°¾ã€‚aof_buf æ˜¯ä¸ªå…¨å±€çš„ SDS ç±»å‹çš„ç¼“å†²åŒºã€‚AOF æŒä¹…åŒ–æœ€ç»ˆéœ€è¦å°†ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ AOF å†™å…¥ã€‚</p><h4 id="AOF-æ–‡ä»¶å†™å…¥"><a href="#AOF-æ–‡ä»¶å†™å…¥" class="headerlink" title="AOF æ–‡ä»¶å†™å…¥"></a>AOF æ–‡ä»¶å†™å…¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†™æ–‡ä»¶é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„ write å‡½æ•°æ‰§è¡Œã€‚ä½†æ˜¯ write ä¹‹åæ•°æ®åªæ˜¯ä¿å­˜åœ¨ kernel çš„ç¼“å†²åŒºï¼ŒçœŸæ­£å†™å…¥ç£ç›˜è¿˜éœ€è¦è°ƒç”¨ fsync å‡½æ•°ã€‚fsync æ˜¯ä¸€ä¸ªé˜»å¡å¹¶ä¸”ç¼“æ…¢çš„æ“ä½œï¼Œæ‰€ä»¥ Redis é€šè¿‡ appendfsync é…ç½®æ§åˆ¶æ‰§è¡Œ fsync çš„é¢‘ç‡ã€‚å…·ä½“æœ‰å¦‚ä¸‹ 3 ç§å†™å›ç­–ç•¥ã€‚</p><ul><li>noï¼šä¸æ‰§è¡Œ fsyncï¼Œç”±æ“ä½œç³»ç»Ÿè´Ÿè´£æ•°æ®çš„åˆ·ç›˜ã€‚æ•°æ®å®‰å…¨æ€§æœ€ä½ä½† Redis æ€§èƒ½æœ€é«˜ã€‚</li><li>alwaysï¼šæ¯æ¬¡æ‰§è¡Œå†™å…¥å°±ä¼šæ‰§è¡Œä¸€æ¬¡ fsyncã€‚æ•°æ®å®‰å…¨æ€§æœ€é«˜ä½†ä¼šå¯¼è‡´ Redis æ€§èƒ½é™ä½ã€‚</li><li>everysecï¼šæ¯ 1 ç§’æ‰§è¡Œä¸€æ¬¡ fsync æ“ä½œã€‚å±äºæŠ˜ä¸­æ–¹æ¡ˆï¼Œåœ¨æ•°æ®å®‰å…¨å’Œæ€§èƒ½ä¹‹é—´è¾¾åˆ°ä¸€ä¸ªå¹³è¡¡ã€‚</li></ul><p>ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬é…ç½®ä¸º <strong>appendfsync  everysec</strong>ã€‚ä¸‹é¢æ˜¯ä¸‰ç§å†™å›ç­–ç•¥çš„å›¾ç‰‡æ€»ç»“ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚</p><img src="/images/redis/redis1/aof3.png" style="zoom:50%;"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬ä»¥ Redis æ”¶åˆ°â€set testkey  testvalueâ€œ å‘½ä»¤åè®°å½•çš„æ—¥å¿—ä¸ºä¾‹ï¼Œçœ‹çœ‹ AOF æ—¥å¿—çš„å†…å®¹ã€‚å…¶ä¸­ï¼Œâ€*3â€œ è¡¨ç¤ºå½“å‰å‘½ä»¤æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯éƒ¨åˆ†éƒ½æ˜¯ç”±â€$ + æ•°å­—â€œ å¼€å¤´ã€‚ä¾‹å¦‚ï¼Œâ€$3 setâ€œ  è¡¨ç¤ºè¿™éƒ¨åˆ†æœ‰3ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯â€setâ€ å‘½ä»¤ï¼›â€$7 testkeyâ€œ è¡¨ç¤ºè¿™éƒ¨åˆ†æœ‰ 7 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ â€testkeyâ€œ ç­‰ç­‰ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»¥ä¸Šè§£å†³ AOF ä»å‘½ä»¤è¿½åŠ åˆ°å†™å…¥ AOF æ—¥å¿—æ–‡ä»¶ï¼Œä½†æ˜¯éšç€ Redis ä½¿ç”¨é¢‘ç‡çš„å¢åŠ ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¿›è¡Œå¤§é‡çš„æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¤§é‡çš„å‘½ä»¤ã€‚å¤§é‡çš„å‘½ä»¤ä¼šä½¿ AOF æ—¥å¿—æ–‡ä»¶å¢å¤§ï¼Œå¹¶ä¸”éšç€ AOF æ–‡ä»¶çš„å¢å¤§ï¼Œè¯»å–æ—¥å¿—æ–‡ä»¶çš„æ—¶é—´ä¹Ÿä¼šæ‹‰é•¿ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¾¿æ¨å‡ºäº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µ <strong>AOF é‡å†™</strong>ã€‚</p><h4 id="AOF-é‡å†™æœºåˆ¶"><a href="#AOF-é‡å†™æœºåˆ¶" class="headerlink" title="AOF é‡å†™æœºåˆ¶"></a>AOF é‡å†™æœºåˆ¶</h4><p>AOF é‡å†™é€šè¿‡ä¸»çº¿ç¨‹ <strong>fork</strong> å‡ºä¸€ä¸ªå­è¿›ç¨‹ bgerwriteaof æ¥æ‰§è¡Œã€‚å°±æ˜¯å°†å¤šæ¡å‘½ä»¤å˜ä¸ºä¸€æ¡å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š</p><p>6379&gt; rpush list 1 2 3</p><p>(Integer) 3</p><p>6379&gt;  rpush list 4           // list ä¸­ å¢åŠ  4</p><p>(integer) 4 </p><p>6379&gt;  rpush  list  5         // list ä¸­å¢åŠ  5</p><p>(integer) 5</p><p>6379&gt;  lpop   list               // å¼¹å‡ºç¬¬ä¸€ä¸ªå…ƒç´ </p><p>é‚£ä¹ˆ AOF ä¼šä¿å­˜å¯¹ list æ“ä½œçš„ 4 æ¡å‘½ä»¤</p><p>6379&gt; lrange list 0  -1          // è¾“å‡º list ä¸­æ‰€æœ‰å…ƒç´ </p><p>4 æ¡å‘½ä»¤å˜ä¸ºä¸€æ¡å‘½ä»¤ï¼Œå¯ä»¥å‡å°æ–‡ä»¶å¤§å°ï¼Œåˆå¯ä»¥æé«˜åŠ è½½é€Ÿåº¦ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è€Œfork å‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œçš„ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªæ–° AOF æ–‡ä»¶çš„ä»»åŠ¡ä¼šè¿›è¡Œå¤§é‡çš„å†™å…¥æ“ä½œï¼Œä¼šé•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹ï¼Œè€Œåœ¨è¿™æœŸé—´å¯èƒ½æ— æ³•å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„å‘½ä»¤è¯·æ±‚ã€‚è¿™æ˜¯ Redis æ‰€ä¸å¸Œæœ›çš„ï¼Œå› æ­¤é‡å†™æ“ä½œä¼šäº¤ç»™å­è¿›ç¨‹æ¥æ‰§è¡Œã€‚ï¼ˆåœ¨ fork çš„ä¸€ç¬é—´ä¹Ÿæ˜¯ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„ã€‚ï¼‰</p><h4 id="AOF-é‡å†™è§¦å‘æ–¹å¼"><a href="#AOF-é‡å†™è§¦å‘æ–¹å¼" class="headerlink" title="AOF é‡å†™è§¦å‘æ–¹å¼"></a>AOF é‡å†™è§¦å‘æ–¹å¼</h4><p>æœ‰ä¸¤ç§è§¦å‘æ–¹å¼ï¼šä¸€æ˜¯<strong>é€šè¿‡é…ç½®è‡ªåŠ¨è§¦å‘</strong>ï¼Œä¸€ç§ä¸º<strong>æ‰‹åŠ¨æ‰§è¡Œ bgrewriteaof å‘½ä»¤æ˜¾å¼è§¦å‘</strong>ã€‚é¦–å…ˆæ¥çœ‹è‡ªåŠ¨è§¦å‘æ–¹å¼ã€‚</p><blockquote><p>auto-aof-rewrite-percentage    100</p><p>auto-aof-rewrite-min-size   64mb</p></blockquote><p>è§£é‡Šï¼šå½“ AOF æ–‡ä»¶å¤§äº 64MB æ—¶ï¼Œå¹¶ä¸” AOF æ–‡ä»¶å½“å‰å¤§å°æ¯”åŸºå‡†å¤§å°å¢é•¿äº† 100% æ—¶ä¼šè§¦å‘ä¸€æ¬¡ AOF é‡å†™ã€‚é€šå¸¸å•Šï¼Œç”Ÿäº§ä¸Šä¼šå°† auto-aof-rewrite-min-size è‡³å°‘è®¾ç½®ä¸º 5G å·¦å³ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é‡å†™æ—¥å¿—å‡ºç°é—®é¢˜å°±æ‰”äº†ã€‚ é‡å†™æ—¥å¿—çš„æ—¶å€™æ–°çš„å†™å‘½ä»¤ä¼šåœ¨ç¼“å†²åŒºé‡Œé¢ï¼Œç­‰åˆ°é‡å†™å®Œæˆäº†ä¼šå‘é€ä¿¡å·ç»™ä¸»çº¿ç¨‹ï¼Œç„¶åæŠŠç¼“å†²åŒºæ—¥å¿—å†™åˆ°é‡å†™æ—¥å¿—é‡Œé¢ï¼Œå°±å¯ä»¥ä»¥æ–°æ¢æ—§äº†ã€‚ç”±æ­¤å¯è§ï¼ŒAOF é€šè¿‡é‡å†™è§£å†³äº†æ–‡ä»¶è†¨èƒ€çš„é—®é¢˜ã€‚éšåï¼ŒRedis æœåŠ¡å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶æ¥æ›¿æ¢ç°æœ‰çš„ AOF æ–‡ä»¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸è¿‡ï¼Œä½¿ç”¨å­è¿›ç¨‹ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦å¤„ç†ï¼Œå› ä¸ºå­è¿›ç¨‹åœ¨è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œè€Œæ–°çš„å‘½ä»¤å¯èƒ½ä¼šå¯¹æ•°æ®åº“çŠ¶æ€è¿›è¡Œä¿®æ”¹ã€‚ä»è€Œä½¿å¾—æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€å’Œé‡å†™åçš„æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ã€‚ </p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºäº†è§£å†³è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼ŒRedis æœåŠ¡å™¨è®¾ç½®äº†ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><h4 id="AOF-åå°é‡å†™"><a href="#AOF-åå°é‡å†™" class="headerlink" title="AOF åå°é‡å†™"></a>AOF åå°é‡å†™</h4><p>åœ¨å­è¿›ç¨‹æ‰§è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªå·¥ä½œï¼š</p><ul><li><p>æ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„å‘½ä»¤</p></li><li><p>å°†æ‰§è¡Œåçš„å‘½ä»¤è¿½åŠ åˆ° AOF ç¼“å†²åŒº</p></li><li><p>åœ¨ fork å­è¿›ç¨‹çš„åŒæ—¶ä¼šæŠŠä¸»çº¿ç¨‹çš„å†…å­˜æ‹·è´ä¸€ä»½ç»™ begrewriteaof å­è¿›ç¨‹ã€‚ï¼ˆè¿™é‡Œçš„æ‹·è´ä¸æ˜¯ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯å­è¿›ç¨‹å¤åˆ¶äº†çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œå³è™šå®æ˜ å°„å…³ç³»ã€‚fork é‡‡ç”¨äº†æ“ä½œç³»ç»Ÿç³»ç»Ÿçš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œå°±æ˜¯ä¸ºäº†é¿å…ä¸€æ¬¡æ€§æ‹·è´å¤§é‡å†…å­˜æ•°æ®ç»™å­è¿›ç¨‹é€ æˆé•¿æ—¶é—´é˜»å¡é—®é¢˜ã€‚ï¼‰</p></li></ul><p>å½“å­è¿›ç¨‹å®Œå…¨ AOF é‡å†™å·¥ä½œä¹‹åï¼Œå®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥åˆ°è¯¥ä¿¡å·ä¹‹åä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹å·¥ä½œï¼š</p><p>1ï¼‰å°† AOF  é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™åˆ°æ–°çš„ AOF æ–‡ä»¶ä¸­ï¼Œè¿™æ—¶æ–° AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€å’ŒæœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚</p><p>2ï¼‰å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹åï¼ŒåŸå­åœ°è¦†ç›–æ‰€æœ‰çš„ AOF  æ–‡ä»¶ï¼Œå®Œæˆä¿¡å°±ä¸¤ä¸ª AOF æ–‡ä»¶çš„æ›¿æ¢ã€‚</p><h3 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h3><p>åˆ°è¿™é‡Œ Redis æŒä¹…åŒ–å°±ç»™å¤§å®¶æ€»ç»“å®Œäº†ï¼Œå¦‚æœæœ‰ä»€ä¹ˆè®²çš„ä¸ä»”ç»†çš„å¯ä»¥ç»™æˆ‘ææ„è§ï¼Œæˆ‘ä¼šè®¤çœŸä¿®æ”¹çš„ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p>ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹â€”é»„å»ºå® è‘—</p><p>ã€ŠRedis 5è®¾è®¡ä¸æºç åˆ†æã€‹â€”- é™ˆé›· ç­‰ç¼–è‘—</p><p>æå®¢æ—¶é—´ï¼ˆRedis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ï¼‰</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä»æ‰€å‘¨çŸ¥ï¼ŒRedis çš„æ•°æ®å…¨éƒ¨æ”¾åœ¨å†…å­˜é‡Œï¼Œå¦‚æœçªç„¶å®•æœºï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œå› æ­¤å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶æ¥ä¿è¯ Redis çš„æ•°æ®ä¸ä¼šå› ä¸ºæ•…éšœè€Œä¸¢å¤±ï¼Œè¿™ç§æœºåˆ¶å°±æ˜¯ &lt;strong&gt;Redis çš„æŒä¹…åŒ–æœºåˆ¶&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;Redis æœ‰ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼šä¸€ç§ä¸º &lt;st</summary>
      
    
    
    
    <category term="Redis" scheme="http://example.com/categories/Redis/"/>
    
    
    <category term="æ•°æ®åº“" scheme="http://example.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>é‡å…¥é” ReentrantLock æºç æµ…æï¼ˆäºŒï¼‰</title>
    <link href="http://example.com/2020/12/18/ReentrantLock2/"/>
    <id>http://example.com/2020/12/18/ReentrantLock2/</id>
    <published>2020-12-18T12:46:25.000Z</published>
    <updated>2020-12-18T08:27:51.621Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šç¯‡æ–‡ç« ä¸»è¦è®²äº† ReentrantLock çš„åŠ é”å’Œå…¥é˜Ÿå†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠé‡Šæ”¾é”å’Œå‡ºé˜Ÿçš„å†…å®¹ã€‚é¡ºä¾¿å¸¦ä¸€ä¸‹éå…¬å¹³é”ï¼Œç›´æ¥è¿›å…¥ä¸»é¢˜ã€‚</p><h3 id="AQS-é‡Šæ”¾é”é€»è¾‘"><a href="#AQS-é‡Šæ”¾é”é€»è¾‘" class="headerlink" title="AQS é‡Šæ”¾é”é€»è¾‘"></a>AQS é‡Šæ”¾é”é€»è¾‘</h3><h4 id="release-int-arg"><a href="#release-int-arg" class="headerlink" title="release(int arg)"></a>release(int arg)</h4><p>é‡Šæ”¾é”çš„è°ƒç”¨å…³ç³»</p><p>ReentrantLock.unpark() â€”&gt; sync.release() â€”&gt; AQS æä¾›çš„ relsese</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//å°è¯•é‡Šæ”¾é”ï¼Œä¸º true,åˆ™è¡¨ç¤ºå®Œå…¨é‡Šæ”¾é”ã€‚</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// head ä»€ä¹ˆæ—¶å€™ä¼šè¢«åˆ›å»ºå‡ºæ¥</span>      <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æœªé‡Šæ”¾çº¿ç¨‹æ—¶ï¼Œä¸”æŒé”æœŸé—´ï¼Œæœ‰å…¶ä»–çº¿ç¨‹æƒ³è¦è·å–é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å‘ç°è·å–ä¸åˆ°é”ï¼Œ</span>      <span class="token comment" spellcheck="true">// è€Œä¸”é˜Ÿåˆ—æ˜¯ç©ºé˜Ÿåˆ—ï¼Œæ­¤æ—¶åç»­çº¿ç¨‹ä¼šä¸ºå½“å‰æŒé”ä¸­çš„çº¿ç¨‹æ„å»ºå‡ºæ¥ä¸€ä¸ª head èŠ‚ç‚¹ï¼Œ</span>      <span class="token comment" spellcheck="true">// ç„¶ååç»­çº¿ç¨‹ä¼šè¿½åŠ åˆ° head èŠ‚ç‚¹åé¢ã€‚</span>      Node h <span class="token operator">=</span> head<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// æ¡ä»¶ä¸€ï¼šæˆç«‹ï¼Œè¯´æ˜é˜Ÿåˆ—ä¸­çš„headèŠ‚ç‚¹å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼ŒReentrantLock åœ¨ä½¿ç”¨æœŸé—´å‘ç”Ÿè¿‡å¤šçº¿ç¨‹ç«äº‰</span>      <span class="token comment" spellcheck="true">// æ¡ä»¶äºŒï¼šæˆç«‹ï¼Œè¯´æ˜å½“å‰head åé¢ä¸€å®šæ’å…¥è¿‡èŠ‚ç‚¹</span>      <span class="token comment" spellcheck="true">//ï¼ˆhead å½“å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™æ˜¯0ï¼Œä½†æ˜¯åé¢å¦‚æœæœ‰èŠ‚ç‚¹æ’å…¥åˆ™ä¼šå°†å½“å‰headèŠ‚ç‚¹çš„ ws ä¿®æ”¹ä¸º -1ï¼‰</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// å”¤é†’åç»§èŠ‚ç‚¹</span>        <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å‡å»é‡Šæ”¾çš„å€¼..</span>    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰çº¿ç¨‹å¹¶æœªæŒé”ï¼Œç›´æ¥å¼‚å¸¸ã€‚</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æŒæœ‰é”</span>    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾é”</span>    <span class="token comment" spellcheck="true">// åªæœ‰å½“å‰çº¿ç¨‹çš„ state å€¼ä¸º 0ï¼Œæ‰æ˜¯å®Œå…¨é‡Šæ”¾é”</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> free<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="unparkSuccessor-Node-node"><a href="#unparkSuccessor-Node-node" class="headerlink" title="unparkSuccessor(Node node)"></a>unparkSuccessor(Node node)</h4><p>AQS ä¸­çš„ unparkSuccessorã€‚</p><p>å”¤é†’å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ”¹æˆ 0 çš„åŸå› ï¼šå› ä¸ºå½“å‰èŠ‚ç‚¹å·²ç»å®Œæˆå”¤é†’åç»§èŠ‚ç‚¹çš„ä»»åŠ¡äº†ã€‚</span>            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªåç»§èŠ‚ç‚¹</span>        Node s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*         *ä»€ä¹ˆæ—¶å€™ s ç­‰äº null å‘¢         *1.å½“å‰èŠ‚ç‚¹å°±æ˜¯ tail èŠ‚ç‚¹æ—¶         *2.å½“èŠ‚ç‚¹æœªå…¥é˜Ÿå®Œæˆæ—¶         *  é‡è¿°ä¸€éå…¥é˜Ÿè¿‡ç¨‹ï¼š         *    â‘  è®¾ç½®æ–°èŠ‚ç‚¹çš„ prev æŒ‡å‘ pred         *    â‘¡ cas è¿™åªæ–°èŠ‚ç‚¹ä¸º tail         *    â‘¢ Pred.next æŒ‡å‘æ–°èŠ‚ç‚¹ï¼ˆæ­¤å¤„æœªå®Œæˆï¼‰         *  å½“ â‘¢ è¿˜æœªå®Œæˆæ—¶å½“å‰èŠ‚ç‚¹è°ƒç”¨ release, é‚£ä¹ˆä½ æ‹¿åˆ°çš„ node.next ä¸º Null         *éœ€è¦æ‰¾åˆ°å¯ä»¥å”¤é†’çš„èŠ‚ç‚¹         */</span>          <span class="token comment" spellcheck="true">//æ¥ä¸‹æ¥çœ‹æ¡ä»¶äºŒ</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¿›å…¥æ¡ä»¶äºŒï¼Œé‚£ä¹ˆè¯´æ˜ s != null</span>        <span class="token comment" spellcheck="true">//è¯´æ˜ s èŠ‚ç‚¹ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œé‚£ä¹ˆéœ€è¦æ‰¾ä¸€ä¸ªåˆé€‚çš„å¯ä»¥è¢«å”¤é†’çš„èŠ‚ç‚¹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æŸ¥æ‰¾å¯ä»¥è¢«å”¤é†’çš„èŠ‚ç‚¹</span>            s <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ä»é˜Ÿå°¾éå†ï¼Œä¼šæ‰¾åˆ°ä¸€ä¸ªç¦»å½“å‰ node æœ€è¿‘çš„ä¸€ä¸ªå¯ä»¥è¢«å”¤é†’çš„ nodeï¼Œ</span>            <span class="token comment" spellcheck="true">// node å¯èƒ½æ‰¾ä¸åˆ°ï¼Œnode å¯èƒ½æ˜¯ null</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>Node t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>                    s <span class="token operator">=</span> t<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¦‚æœæ‰¾åˆ°åˆé€‚çš„å¯ä»¥è¢«å”¤é†’çš„ nodeï¼Œåˆ™å”¤é†’..æ‰¾ä¸åˆ° ä»€ä¹ˆä¹Ÿä¸åšã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span>            LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æ€»çš„æ¥è¯´ä¸€ä¸‹ä¸Šé¢ä¸‰ä¸ªæ–¹æ³•ã€‚é¦–å…ˆå¦‚æœæˆ‘ä»¬è°ƒç”¨ ReentrantLock çš„ unpark æ–¹æ³•ï¼Œå®é™…ä¸Šæˆ‘ä»¬å°±æ˜¯è°ƒç”¨ AQSçš„ release æ–¹æ³•ã€‚åœ¨ release æ–¹æ³•é‡Œæˆ‘ä»¬é¦–å…ˆä¼šå»å°è¯•é‡Šæ”¾é”ï¼Œä»€ä¹ˆæ—¶å€™ç®—å®Œå…¨é‡Šæ”¾é”å‘¢ï¼Œå½“å‰çº¿ç¨‹çš„ state = 0çš„æ—¶å€™ã€‚å¦‚æœå½“å‰ state å€¼ä¸º 0ï¼Œé‚£ä¹ˆå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ç©ºå¹¶ä¸”ä¸æ˜¯å°¾èŠ‚ç‚¹çš„è¯æˆ‘ä»¬å°±ä¼šå°è¯•å”¤é†’åç»§èŠ‚ç‚¹ã€‚å»é˜»å¡é˜Ÿåˆ—é‡Œæ‰¾åˆ°è·ç¦»å½“å‰èŠ‚ç‚¹æœ€è¿‘çš„ï¼Œå¹¶ä¸”å”¤é†’ waitStatus å°äºç­‰äº 0 çš„èŠ‚ç‚¹ã€‚ä»¥ä¸Šå°±æ˜¯é‡Šæ”¾é”çš„å¤§ä½“é€»è¾‘ã€‚</p><h3 id="AQS-å“åº”ä¸­æ–­å‡ºé˜Ÿ"><a href="#AQS-å“åº”ä¸­æ–­å‡ºé˜Ÿ" class="headerlink" title="AQS å“åº”ä¸­æ–­å‡ºé˜Ÿ"></a>AQS å“åº”ä¸­æ–­å‡ºé˜Ÿ</h3><h4 id="cancelAcquire-Node-node"><a href="#cancelAcquire-Node-node" class="headerlink" title="cancelAcquire(Node node)"></a>cancelAcquire(Node node)</h4><p>å–æ¶ˆæŒ‡å®š node å‚ä¸ç«äº‰</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å› ä¸ºå·²ç»å–æ¶ˆæ’é˜Ÿäº†ï¼Œæ‰€ä»¥ node å†…éƒ¨å…³è”çš„å½“å‰çº¿ç¨‹ï¼Œç½®ä¸º NULL å°±å¥½äº†</span>    node<span class="token punctuation">.</span>thread <span class="token operator">=</span> null<span class="token punctuation">;</span>    Node pred <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>      node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>    Node predNext <span class="token operator">=</span> pred<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å°†å½“å‰node çŠ¶æ€è®¾ç½®ä¸º å–æ¶ˆçŠ¶æ€ 1</span>    node<span class="token punctuation">.</span>waitStatus <span class="token operator">=</span> Node<span class="token punctuation">.</span>CANCELLED<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*     * å½“å‰å–æ¶ˆæ’é˜Ÿçš„node æ‰€åœ¨é˜Ÿåˆ—çš„ä½ç½®ä¸åŒï¼Œæ‰§è¡Œçš„å‡ºé˜Ÿç­–ç•¥æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸€å…±åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š     * 1.å½“å‰ node æ˜¯é˜Ÿå°¾  tail -> node     * 2.å½“å‰ node ä¸æ˜¯ head.next èŠ‚ç‚¹ï¼Œä¹Ÿä¸æ˜¯ tail     * 3.å½“å‰ node æ˜¯ head.next èŠ‚ç‚¹     */</span>    <span class="token comment" spellcheck="true">//æ¡ä»¶ä¸€ï¼š node == tail  å½“å‰ Node æ˜¯é˜Ÿå°¾</span>    <span class="token comment" spellcheck="true">//æ¡ä»¶äºŒï¼š æˆåŠŸçš„è¯ï¼Œè¯´æ˜ä¿®æ”¹ tail å®Œæˆ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> tail <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> pred<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰node æ˜¯é˜Ÿå°¾çš„è¯è‚¯å®šè¦å°† node ä¸å‰ç»§èŠ‚ç‚¹æ–­å¼€ç„¶åå°¾æŒ‡é’ˆæŒ‡å‘å‰ç»§èŠ‚ç‚¹</span>      <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">int</span> ws<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// å½“å‰ node ä¸æ˜¯ head.next èŠ‚ç‚¹ï¼Œä¹Ÿä¸æ˜¯ tail</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> head <span class="token operator">&amp;&amp;</span>          <span class="token comment" spellcheck="true">// æ¡ä»¶2.1ï¼šæˆç«‹ï¼Œè¯´æ˜ node çš„å‰é©±çŠ¶æ€æ˜¯ signal çŠ¶æ€</span>          <span class="token comment" spellcheck="true">//         ä¸æˆç«‹ï¼šå‰é©±çŠ¶æ€å¯èƒ½æ˜¯ 0 ï¼Œä¹Ÿå¯èƒ½æ˜¯ 1ï¼ˆå‰é©±ä¹Ÿå–æ¶ˆæ’é˜Ÿ..ï¼‰</span>          <span class="token comment" spellcheck="true">// æ¡ä»¶2.2ï¼šå‡è®¾å‰é©±çŠ¶æ€ &lt;= 0ï¼Œåˆ™è®¾ç½®å‰é©±çŠ¶æ€ä¸º Signal çŠ¶æ€..è¡¨ç¤ºè¦å”¤é†’åç»§èŠ‚ç‚¹ã€‚</span>          <span class="token comment" spellcheck="true">//if é‡Œé¢ï¼šå°±æ˜¯è®© pred.next -> node.nextï¼Œæ‰€ä»¥éœ€è¦ä¿è¯ pred èŠ‚ç‚¹çŠ¶æ€ä¸º signal çŠ¶æ€</span>          <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">)</span> <span class="token operator">==</span> Node<span class="token punctuation">.</span>SIGNAL <span class="token operator">||</span>           <span class="token punctuation">(</span>ws <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>          pred<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å‡ºé˜Ÿï¼špred.next -> node.next èŠ‚ç‚¹åï¼Œå½“ node.next èŠ‚ç‚¹è¢«å”¤é†’å</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ shouldParkAfterFailedAcquire ä¼šè®© node.next èŠ‚ç‚¹è¶Šè¿‡å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹</span>        <span class="token comment" spellcheck="true">// å®ŒæˆçœŸæ­£å‡ºé˜Ÿ</span>        Node next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>          <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//å½“å‰ node æ˜¯ head.next èŠ‚ç‚¹</span>        <span class="token comment" spellcheck="true">// åç»§èŠ‚ç‚¹å”¤é†’åï¼Œä¼šè°ƒç”¨ shouldParkAfterFailedAcquire ä¼šè®© node.next èŠ‚ç‚¹è¶Šè¿‡å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹</span>        <span class="token comment" spellcheck="true">// é˜Ÿåˆ—çš„ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ ä¼š ç›´æ¥ä¸ head å»ºç«‹ åŒé‡æŒ‡å‘çš„å…³ç³»ï¼šhead.next -> ç¬¬ä¸‰ä¸ª node ä¸­é—´å°±æ˜¯è¢«å‡ºé˜Ÿ                 //çš„ head.next ç¬¬ä¸‰ä¸ª node.prev -> head(ä¸‹é¢æœ‰ç®€å›¾)</span>        <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// æŒ‡å‘è‡ªå·±ï¼Œå‡ºé˜Ÿ</span>      node<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// help GC</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><img src="C:\Users\MrZhang\AppData\Roaming\Typora\typora-user-images\image-20201214212403096.png" alt="image-20201214212403096" style="zoom:0%;" /><h3 id="AQS-éå…¬å¹³é”"><a href="#AQS-éå…¬å¹³é”" class="headerlink" title="AQS éå…¬å¹³é”"></a>AQS éå…¬å¹³é”</h3><p>é¡ºå¸¦è¯´å‡ å˜´éå…¬å¹³é”ï¼Œå¦‚æœä½ ç†è§£äº†å…¬å¹³é”ï¼Œéå…¬å¹³é”åªæ˜¯ç¨æœ‰ä¸åŒã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 7316153563782823691L<span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸Šæ¥å°±å°è¯•åŠ é”ï¼Œä¹Ÿä¸ç®¡é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œä¹Ÿä¸ç®¡å½“å‰çŠ¶æ€æœ‰æ²¡æœ‰åŠ é”ã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// æŠ¢å æˆåŠŸè®¾ç½®ç‹¬å </span>            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰çŠ¶æ€ä¸º0ï¼Œå®ƒè¿˜æ˜¯ä¸åˆ¤æ–­å½“å‰é˜Ÿåˆ—é‡Œæ˜¯å¦æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œç›´æ¥å°è¯•æŠ¢é”</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ²¡æˆåŠŸæŸ¥çœ‹æœ‰æ²¡æœ‰é‡å…¥</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// overflow</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// æ¥ä¸‹æ¥éƒ½ä¸€æ ·ï¼Œè¯¥å…¥é˜Ÿåˆ—å…¥é˜Ÿåˆ—ï¼Œè¯¥æŠ¢å èµ„æºæŠ¢å èµ„æº</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æ‰€ä»¥ï¼Œéå…¬å¹³ä¸å…¬å¹³é”å°±ä¸¤ç‚¹åŒºåˆ«ï¼šâ‘  lock çš„æ—¶å€™ä¼šå…ˆå°è¯•æŠ¢ä¸€ä¸‹é”ï¼Œæ‹¿ä¸åˆ° è°ƒç”¨ tryAquireï¼›â‘¡ æŠ¢é”æ—¶éƒ½ä¸å»åˆ¤æ–­é˜Ÿåˆ—é‡Œæ˜¯å¦æœ‰ç­‰å¾…çº¿ç¨‹ã€‚å…¶ä»–æµç¨‹ä¸€æ ·ã€‚éå…¬å¹³é”æ—¶é»˜è®¤æƒ…å†µä¸‹çš„ä¸€ç§ç­–ç•¥ã€‚</p><p>è‡³æ­¤ï¼ŒAQS çš„ ReentrantLock çš„æºç å°±åˆ†æå®Œæˆäº†ï¼Œ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸Šç¯‡æ–‡ç« ä¸»è¦è®²äº† ReentrantLock çš„åŠ é”å’Œå…¥é˜Ÿå†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠé‡Šæ”¾é”å’Œå‡ºé˜Ÿçš„å†…å®¹ã€‚é¡ºä¾¿å¸¦ä¸€ä¸‹éå…¬å¹³é”ï¼Œç›´æ¥è¿›å…¥ä¸»é¢˜ã€‚&lt;/p&gt;
&lt;h3 id=&quot;AQS-é‡Šæ”¾é”é€»è¾‘&quot;&gt;&lt;a href=&quot;#AQS-é‡Šæ”¾é”é€»è¾‘&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    <category term="AQS" scheme="http://example.com/categories/AQS/"/>
    
    
    <category term="Java" scheme="http://example.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>é‡å…¥é” ReentrantLock æºç æµ…æï¼ˆä¸€ï¼‰</title>
    <link href="http://example.com/2020/12/12/ReentrantLock/"/>
    <id>http://example.com/2020/12/12/ReentrantLock/</id>
    <published>2020-12-12T12:46:25.000Z</published>
    <updated>2020-12-13T10:45:16.334Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Java é™¤äº†ä½¿ç”¨å…³é”®å­— synchronized å¤–ï¼Œè¿˜ä½¿ç”¨äº† ReentrantLock å®ç°ç‹¬å ã€å¯é‡å…¥é”çš„åŠŸèƒ½ã€‚ç›¸è¾ƒäº synchronizedï¼ŒReentrantLock æ›´ä¸ºä¸°å¯Œå’Œçµæ´»ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬æˆ–å¤šæˆ–å°‘è¿˜å¬è¯´è¿‡ä¸€ä¸ªåè¯ AQSã€‚AQS æ˜¯Java æä¾›çš„åº•å±‚åŒæ­¥å·¥å…·ï¼Œç”¨ä¸€ä¸ª int ç±»å‹çš„å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œæä¾›ä¸€ç³»åˆ—çš„ CAS æ“ä½œæ¥ç®¡ç†è¿™ä¸ªåŒæ­¥çŠ¶æ€ã€‚æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ ReentrantLock ä¹Ÿæ˜¯åŸºäº AQS å®ç°çš„ã€‚å¥½çš„ï¼ŒåºŸè¯å°‘è¯´ï¼Œæˆ‘ä»¬å¼€å§‹æºç çš„æ¢ç´¢è·¯ç¨‹ã€‚</p><h3 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆå•Šï¼Œæˆ‘ä»¬æ‰“å¼€æºç å°±çœ‹åˆ°äº† ReentrantLock å®ç°äº† Lock æ¥å£ï¼Œé‚£ä¹ˆ Lock é‡Œé¢çš„ä¸€äº›åŠ é”å•Šè§£é”å•Šç­‰æ–¹æ³•è‡ªç„¶ä¹Ÿè¦ä¸€ä¸€å®ç°ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable </code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¶å®ReentrantLock å°±ä¸€ä¸ªå±æ€§ï¼Œé‚£å°±æ˜¯ syncã€‚ä½† ReentrantLock è‡ªå·±å®ç°äº†ä¸€ä¸ª Sync çš„é™æ€å†…éƒ¨ç±»ã€‚è¿™ä¸ª Sync ç»§æ‰¿äº† AbstractQueuedSynchronizerï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ AQSã€‚æ‰€ä»¥ AQS ä¸­çš„ä¸€äº›é‡è¦å±æ€§è‡ªç„¶è€Œç„¶ä¹Ÿè¢«ReentrantLock ç»§æ‰¿ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿›å…¥ AbstractQueuedSynchronizerï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥çœ‹åˆ°é‡Œé¢ä¹Ÿå®ç°äº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±» Nodeã€‚è¿™ä¸ª Node è‡³å…³é‡è¦ï¼Œå®ƒä¼šå‡ºç°åœ¨æ¥ä¸‹æ¥çš„æ‰€æœ‰å†…å®¹ä¸­ã€‚è¿™æ¬¡æˆ‘åªåˆ—ä¸¾äº†ReentrantLock éœ€è¦ç”¨åˆ°çš„å±æ€§ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/** Marker to indicate a node is waiting in shared mode */</span>        <span class="token comment" spellcheck="true">/** å…±äº«æ¨¡å¼ */</span>        <span class="token keyword">static</span> <span class="token keyword">final</span> Node SHARED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** Marker to indicate a node is waiting in exclusive mode */</span>        <span class="token comment" spellcheck="true">/** ç‹¬å æ¨¡å¼ */</span>        <span class="token keyword">static</span> <span class="token keyword">final</span> Node EXCLUSIVE <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** waitStatus value to indicate thread has cancelled */</span>        <span class="token comment" spellcheck="true">/** è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å¤„äº å–æ¶ˆ çŠ¶æ€ */</span>        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CANCELLED <span class="token operator">=</span>  <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** waitStatus value to indicate successor's thread needs unparking */</span>        <span class="token comment" spellcheck="true">/** è¡¨ç¤ºå½“å‰èŠ‚ç‚¹éœ€è¦å”¤é†’åç»§èŠ‚ç‚¹ */</span>        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIGNAL    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** node èŠ‚ç‚¹çš„çŠ¶æ€ */</span>        <span class="token keyword">volatile</span> <span class="token keyword">int</span> waitStatus<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** å› ä¸ºéœ€è¦æ„å»ºåŒæƒ³é“¾è¡¨ï¼Œæ‰€ä»¥ prev è¡¨ç¤ºæŒ‡å‘ node èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹*/</span>        <span class="token keyword">volatile</span> Node prev<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** æŒ‡å‘ node èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹*/</span>        <span class="token keyword">volatile</span> Node next<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** node å°è£…çš„çº¿ç¨‹ */</span>        <span class="token keyword">volatile</span> Thread thread<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** é˜»å¡é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ å¤´èŠ‚ç‚¹å¯¹åº”çš„éƒ½æ˜¯å½“å‰çº¿ç¨‹*/</span>        <span class="token comment" spellcheck="true">/** è¿™é‡Œçš„ head å¹¶ä¸æ˜¯é˜»å¡é˜Ÿåˆ—åŒå‘é“¾è¡¨çš„ headï¼Œå¯ä»¥æŠŠ head.next å½“åšé˜»å¡é˜Ÿåˆ—çš„å¼€å§‹         *  æˆ‘åœ¨è¿™é‡Œå°±çŠ¯äº†è¿·ç³Šï¼Œåœ¨ç©ºé˜Ÿåˆ—çš„å®šä¹‰ä¸ŠçŠ¹è±«äº†ä¸€ä¼šï¼Œæ‰€ä»¥è¿™é‡Œç»™å¤§å®¶æä¸ªé†’ã€‚          */</span>        <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> Node head<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * Tail of the wait queue, lazily initialized.  Modified only via         * method enq to add new wait node.         */</span>        <span class="token comment" spellcheck="true">/** é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ */</span>        <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> Node tail<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * The synchronization state.         */</span>        <span class="token comment" spellcheck="true">// è¡¨ç¤ºèµ„æº</span>        <span class="token comment" spellcheck="true">// ç‹¬å æ¨¡å¼ï¼š0 è¡¨ç¤ºæœªåŠ é”çŠ¶æ€ï¼Œ>0 è¡¨ç¤ºåŠ é”çŠ¶æ€</span>        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReentrantLock é‡Œé¢éœ€è¦ç”¨åˆ°çš„å±æ€§å°±å¤§è‡´è®²å®Œäº†ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªçŠ¶æ€ç ä¸º 0 çš„ï¼Œå®ƒä»£è¡¨å½“å‰èŠ‚ç‚¹æ˜¯æ–°å»ºçš„èŠ‚ç‚¹ã€‚å“¦ï¼Œå¯¹äº†ï¼ŒAbstractQueuedSynchronizer è¿˜ç»§æ‰¿äº†ä¸€ä¸ªæŠ½è±¡ç±» AbstractOwnableSynchronizerï¼Œé‡Œé¢çš„exclusiveOwnerThread å±æ€§åŠå…¶ getã€set æ–¹æ³•ä¹Ÿæ˜¯é‡ç‚¹å¯¹è±¡ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ç‹¬å é”æ¨¡å¼ï¼šè¡¨ç¤ºå½“å‰ç‹¬å é”çº¿ç¨‹</span><span class="token keyword">private</span> <span class="token keyword">transient</span> Thread exclusiveOwnerThread<span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>Thread thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>     exclusiveOwnerThread <span class="token operator">=</span> thread<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">protected</span> <span class="token keyword">final</span> Thread <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> exclusiveOwnerThread<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä»‹ç»å®Œå±æ€§ï¼Œæ¥ä¸‹æ¥å¼€å§‹è¿›å…¥æºç çš„é˜…è¯»ï¼Œè¿™æ¬¡ä¸»è®²å…¬å¹³é”ã€‚å…ˆå¤§è‡´åˆ—ä¸¾ä¸€ä¸‹åŠ é”é˜¶æ®µçš„æ–¹æ³•ã€‚</p><p>lock()</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“&gt;acquire() ç«äº‰èµ„æº</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“&gt; tryAquire() å°è¯•è·å–é”</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“&gt; acquireQueued()  æŒ‚èµ·å½“å‰çº¿ç¨‹</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“&gt; shouldParkAfterFailedAcquire()// å½“å‰çº¿ç¨‹è·å–é”èµ„æºå¤±è´¥åæ˜¯å¦éœ€è¦æŒ‚èµ·å‘¢ï¼Ÿ</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true: éœ€è¦ï¼›  false  ä¸éœ€è¦</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“&gt; parkAndCheckInterrupt()  æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå”¤é†’ä¹‹åè¿”å›å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| â€“&gt; addWaiter()å°†å½“å‰çº¿ç¨‹å°è£…æˆnode</p><p>OKï¼Œå¤§è‡´éª¨æ¶æ¢³ç†å®Œäº†ï¼Œæºç å¼€å§‹ï¼Œgogogogo!!</p><h3 id="acquire-int-arg-â€“-åŠ é”"><a href="#acquire-int-arg-â€“-åŠ é”" class="headerlink" title="acquire(int arg) â€“ åŠ é”"></a>acquire(int arg) â€“ åŠ é”</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å…¬å¹³é”å…¥å£ï¼Œä¸å“åº”ä¸­æ–­çš„åŠ é”</span><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å°è¯•è·å–é”ï¼ŒæˆåŠŸè¿”å› trueï¼Œå¤±è´¥è¿”å› false.</span>    <span class="token comment" spellcheck="true">/* addWaiter å°†å½“å‰çº¿ç¨‹å°è£…æˆ node å…¥é˜Ÿ     * acquireQueued æŒ‚èµ·å½“å‰çº¿ç¨‹      *               è¿”å› true è¡¨ç¤ºæŒ‚èµ·è¿‡ç¨‹ä¸­çº¿ç¨‹è¢«ä¸­æ–­å”¤é†’è¿‡     *                                è¿”å› false è¡¨ç¤ºæœªè¢«ä¸­æ–­è¿‡     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>       <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¶ä¸­ï¼Œacquire() å°±æ˜¯ç«äº‰èµ„æºçš„æ–¹æ³•ï¼Œé¦–å…ˆå›å»å°è¯•è·å–é”ï¼ŒæˆåŠŸäº†å°±æ‰§è¡Œå…¶ä¸šåŠ¡é€»è¾‘ï¼Œä¸æˆåŠŸä¼šå°†å…¶åŒ…è£…æˆNodeè¿›å…¥é˜»å¡é˜Ÿåˆ—ä¸­å¹¶æŒ‚èµ·ã€‚</p><h3 id="tryAcquire-int-acquires-â€“-å°è¯•è·å–é”"><a href="#tryAcquire-int-acquires-â€“-å°è¯•è·å–é”" class="headerlink" title="tryAcquire(int acquires) â€“ å°è¯•è·å–é”"></a>tryAcquire(int acquires) â€“ å°è¯•è·å–é”</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è·å–å½“å‰çº¿ç¨‹</span>    <span class="token keyword">final</span> Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// AQS state</span>    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// state == 0 è¡¨ç¤ºå½“å‰ AQS å¤„äºæ— é”çŠ¶æ€</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * æ¡ä»¶1ï¼šhasQueuedPredecessors()          *       trueï¼šå½“å‰çº¿ç¨‹å‰é¢æœ‰ç­‰å¾…è€…ï¼Œå½“å‰çº¿ç¨‹éœ€è¦å…¥é˜Ÿç­‰å¾…         *       falseï¼šå½“å‰çº¿ç¨‹å‰é¢æ— ç­‰å¾…è€…ï¼Œç›´æ¥å°è¯•è·å–é”         * æ¡ä»¶2ï¼šé€šè¿‡ CAS çš„æ–¹å¼è®¾ç½® state         *       successï¼šå½“å‰çº¿ç¨‹æŠ¢å é”æˆåŠŸ         *       failï¼šå­˜åœ¨ç«äº‰ï¼Œä¸”å½“å‰çº¿ç¨‹ç«äº‰å¤±è´¥         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å è€… çº¿ç¨‹</span>            <span class="token comment" spellcheck="true">// æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰è®¾ç½®é˜»å¡é˜Ÿåˆ—çš„ head èŠ‚ç‚¹ï¼Œåç»­åœ¨åˆ†æ addWaiter çš„ enq ä¼šæåˆ°</span>            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// c != 0 éœ€è¦æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯ ç‹¬å é”çš„çº¿ç¨‹ï¼Œå› ä¸ºReentrantLock æ˜¯å¯é‡å…¥çš„</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ›´æ–°å€¼</span>        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è¶Šç•Œåˆ¤æ–­</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 1.CAS å¤±è´¥  c == 0 æ—¶ï¼ŒCAS ä¿®æ”¹ sateæ—¶æœªæŠ¢è¿‡å…¶ä»–çº¿ç¨‹</span>    <span class="token comment" spellcheck="true">// 2. c > 0 ä¸” ownerThread != currentThread.</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å›åˆ° acquireæ–¹æ³•ï¼ŒtryAcquire å¦‚æœè¿”å› true å–ååä¸º falseï¼Œå°±è¿”å›ä¸šåŠ¡å±‚é¢äº†ã€‚å¯å¦‚æœtryAcquire ä¸º falseï¼Œå–ååä¸º trueï¼Œé‚£ä¹ˆå°±è¦è¿›å…¥é˜»å¡é˜Ÿåˆ—æŒ‚èµ·äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ addWaiter()ã€‚</p><h3 id="å…¥é˜Ÿ"><a href="#å…¥é˜Ÿ" class="headerlink" title="å…¥é˜Ÿ"></a>å…¥é˜Ÿ</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Node <span class="token function">addWaiter</span><span class="token punctuation">(</span>Node mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å°†å½“å‰èŠ‚ç‚¹å°è£…åˆ° node ä¸­</span>    Node node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Try the fast path of enq; backup to full enq on failure</span>    Node pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¿«é€Ÿå…¥é˜Ÿ</span>    <span class="token comment" spellcheck="true">// æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºé˜Ÿåˆ—é‡Œé¢æœ‰ node</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å°†node çš„ prev æŒ‡å‘ pred</span>        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// é€šè¿‡ cas çš„æ–¹å¼å°† node å…¥é˜Ÿ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å‰ç½®èŠ‚ç‚¹æŒ‡å‘ nodeï¼Œå®ŒæˆåŒå‘ç»‘å®šã€‚</span>            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>            <span class="token keyword">return</span> node<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ä»€ä¹ˆæ—¶å€™ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Ÿ</span>    <span class="token comment" spellcheck="true">//1. å½“å‰é˜Ÿåˆ—æ˜¯ç©ºé˜Ÿåˆ— tail == null</span>    <span class="token comment" spellcheck="true">//2. cas ç«äº‰å…¥é˜Ÿå¤±è´¥</span>    <span class="token comment" spellcheck="true">// å®Œæ•´å…¥é˜Ÿ</span>    <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¶å®ï¼ŒaddWaiter æ–¹æ³•æ— éå°±æ˜¯å°†å½“å‰çº¿ç¨‹å°è£…æˆ nodeèŠ‚ç‚¹åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—é˜Ÿå°¾ä¸­ã€‚å¦‚æœä¸€åˆ‡è¿›å±•é¡ºåˆ©å³ä¸Šé¢æ‰€è¯´çš„â€œå¿«é€Ÿå…¥é˜Ÿâ€ã€‚å¦‚æœä¸­é—´å‡ºç°é˜»å¡é˜Ÿåˆ—ä¸ºç©ºé˜Ÿåˆ—æˆ–è€… cas æ’å…¥é˜Ÿå°¾å¤±è´¥çš„æƒ…å†µåˆ™è¿›å…¥å®Œæ•´å…¥é˜Ÿã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€ä¸‹å®Œæ•´å…¥é˜Ÿ enq()ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Node <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/** è‡ªæ—‹å…¥é˜Ÿï¼Œåªæœ‰å½“å‰ node å…¥é˜ŸæˆåŠŸåï¼Œæ‰ä¼šè·³å‡ºå¾ªç¯*/</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Node t <span class="token operator">=</span> tail<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*         * é˜Ÿåˆ—ä¸ºç©ºé˜Ÿåˆ—         * è¯´æ˜å½“å‰é” è¢«å ç”¨ï¼Œä¸”å½“å‰çº¿ç¨‹æœ‰å¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªè·å–é”å¤±è´¥çš„çº¿ç¨‹         * ï¼ˆä¸ºä»€ä¹ˆæ˜¯æœ‰å¯èƒ½ï¼Ÿå› ä¸ºå½“å‰æ—¶åˆ»å¯èƒ½å­˜åœ¨ä¸€æ‰¹è·å–é”å¤±è´¥çš„çº¿ç¨‹.ï¼‰         */</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Must initialize</span>            <span class="token comment" spellcheck="true">// ä½œä¸ºå½“å‰æŒé”çº¿ç¨‹çš„ç¬¬ä¸€ä¸ªåç»§çº¿ç¨‹</span>            <span class="token comment" spellcheck="true">// 1.å› ä¸ºå½“å‰æŒé”çº¿ç¨‹åœ¨è·å–é”æ—¶ï¼ˆtryAcquireï¼‰ï¼ŒæˆåŠŸäº†ï¼Œå¹¶æ²¡æœ‰å‘é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ </span>            <span class="token comment" spellcheck="true">//   ä»»ä½•å…ƒç´ ,æ‰€ä»¥è¿™é‡Œè¦é€šè¿‡ cas æ–¹å¼ç»™é˜»å¡é˜Ÿåˆ—æ·»åŠ å¤´èŠ‚ç‚¹ã€‚</span>            <span class="token comment" spellcheck="true">// 2.è‡ªå·±è¿½åŠ èŠ‚ç‚¹</span>            <span class="token comment" spellcheck="true">// ç„¶åæˆ‘ä»¬ä¾¿å¼€å§‹è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ï¼Œä¸‹ä¸€è½®ç›´æ¥è¿›å…¥ else</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                tail <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ç”±äºé˜»å¡é˜Ÿåˆ—ä¸­å·²ç»æœ‰æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„èŠ‚ç‚¹äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†nodeçš„ prevæŒ‡å‘ tail</span>            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// é€šè¿‡casçš„æ–¹å¼å°†å½“å‰ node è®¾ç½®æˆæ–°çš„å°¾èŠ‚ç‚¹</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>                <span class="token keyword">return</span> t<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®Œå…¨å…¥é˜Ÿä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå…¶å®å°±æ˜¯ä¸»è¦è§£å†³ addWaiter æ²¡æœ‰å…¥é˜ŸæˆåŠŸçš„æƒ…å†µã€‚å¦‚æœä½ æ˜¯å› ä¸ºç©ºé˜Ÿåˆ—å…¥é˜Ÿå¤±è´¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è‡ªå·±åˆ›å»ºä¸€ä¸ªå¤´èŠ‚ç‚¹ï¼Œå¦‚æœä½ æ˜¯ç”±äº cas ç«äº‰å…¥é˜Ÿå¤±è´¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è‡ªé€‰å…¥é˜Ÿç›´è‡³æˆåŠŸã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ acquireQueued() äº†ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ–¹æ³•æœ‰ç‚¹çƒ¦çš„ï¼Œæˆ‘ä¼šå°½é‡å¤è¿°æ¸…æ¥šã€‚</p><p>è¿™é‡Œå…ˆç®€å•æ¢³ç†ä¸€ä¸‹ acquireQueued çš„éª¨æ¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;acquireQueued</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“&gt; shouldParkAfterFailedAcquire</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“&gt; parkAndCheckInterrupt</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| â€“&gt; cancelAcquire</p><p>acquireQueued åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ</p><ol><li>å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰è¢« parkï¼Ÿ æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±æŒ‚èµ·ã€‚</li><li>å”¤é†’ä¹‹åçš„é€»è¾‘ã€‚</li></ol><p>å½“ç„¶äº†ï¼Œè¿™ä¸ªæ–¹æ³•ä¾ç„¶æ˜¯ AQSçš„ï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨ï¼š</p><p>   å‚æ•°1ï¼šnode å°±æ˜¯å½“å‰çº¿ç¨‹åŒ…è£…å‡ºæ¥çš„ nodeï¼Œä¸”å½“å‰æ—¶åˆ» å·²ç»å…¥é˜ŸæˆåŠŸ..</p><p>   å‚æ•°2ï¼šå½“å‰çº¿ç¨‹æŠ¢å èµ„æºæˆåŠŸåï¼Œè®¾ç½® state å€¼æ—¶ä¼šç”¨åˆ°ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> Node node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// true è¡¨ç¤ºå½“å‰çº¿ç¨‹æŠ¢å é”æˆåŠŸï¼Œæ™®é€šæƒ…å†µä¸‹ã€lockã€‘ å½“å‰çº¿ç¨‹æ—©æ™šä¼šæ‹¿åˆ°é”</span>    <span class="token comment" spellcheck="true">// false è¡¨ç¤ºå¤±è´¥ï¼Œéœ€è¦æ‰§è¡Œå‡ºé˜Ÿæ“ä½œ</span>    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æ˜¯å¦ä¼šä¸­æ–­</span>        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//è‡ªæ—‹</span>            <span class="token comment" spellcheck="true">// ä»€ä¹ˆæ—¶å€™ä¼šæ‰§è¡Œè¿™é‡Œå‘¢ </span>            <span class="token comment" spellcheck="true">//1.è¿›å…¥ for å¾ªç¯æ—¶ï¼Œåœ¨çº¿ç¨‹å°šæœª park å‰ä¼šæ‰§è¡Œ</span>            <span class="token comment" spellcheck="true">//2.çº¿ç¨‹ park ä¹‹åè¢«å”¤é†’åï¼Œä¹Ÿä¼šæ‰§è¡Œè¿™é‡Œ..</span>            <span class="token keyword">final</span> Node p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//è·å–å½“æœŸçº¿ç¨‹çš„å‰ç½®èŠ‚ç‚¹</span>            <span class="token comment" spellcheck="true">//æ¡ä»¶ä¸€ï¼šæˆç«‹ åˆ™è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸º head.next èŠ‚ç‚¹ï¼Œhead.next èŠ‚ç‚¹åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æƒå»äº‰å¤ºé”</span>            <span class="token comment" spellcheck="true">//æ¡ä»¶äºŒï¼štryAcquire(arg)</span>            <span class="token comment" spellcheck="true">//æˆç«‹ï¼šè¯´æ˜headå¯¹åº”çš„çº¿ç¨‹å·²ç»é‡Šæ”¾é”äº†ï¼Œhead.next èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹æ­£å¥½å–åˆ°é”</span>            <span class="token comment" spellcheck="true">//ä¸æˆç«‹ï¼šè¯´æ˜ head å¯¹åº”çš„çº¿ç¨‹è¿˜æ²¡é‡Šæ”¾é”ï¼Œhead.next ä»ç„¶éœ€è¦è¢«parkã€‚ç„¶ååˆèµ°åˆ°ä¸‹é¢æŒ‚èµ·çš„é€»è¾‘</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ‹¿åˆ°é”ä¹‹åå¹²ä»€ä¹ˆï¼Ÿ</span>                <span class="token comment" spellcheck="true">// é¦–å…ˆè®¾ç½®è‡ªå·±ä¸º headèŠ‚ç‚¹</span>                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å°†å‰ç½®èŠ‚ç‚¹çš„ next å¼•ç”¨ç½®ä¸ºnulã€‚ååŠ©å‡ºé˜Ÿã€‚</span>                p<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// help GC</span>                <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹è·å–é”çš„è¿‡ç¨‹ä¸­æ²¡æœ‰å‡ºç°å¼‚å¸¸</span>                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// è¿”å›å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°</span>                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// shouldParkAfterFailedAcquire </span>            <span class="token comment" spellcheck="true">// è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–é”èµ„æºå¤±è´¥äº†æ˜¯å¦éœ€è¦æŒ‚èµ·å‘¢ï¼Ÿ</span>            <span class="token comment" spellcheck="true">// è¿”å›å€¼ï¼štrue-> å½“å‰çº¿ç¨‹éœ€è¦æŒ‚èµ·  false-> ä¸éœ€è¦..</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                <span class="token comment" spellcheck="true">//parkAndCheckInterrupt</span>                <span class="token comment" spellcheck="true">//æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”å”¤é†’ä¹‹å è¿”å› å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°</span>                <span class="token comment" spellcheck="true">//å”¤é†’ï¼š1.æ­£å¸¸å”¤é†’ å…¶ä»–çº¿ç¨‹ unpark 2.å…¶ä»–çº¿ç¨‹ç»™å½“å‰æŒ‚èµ·çš„çº¿ç¨‹ä¸€ä¸ªä¸­æ–­ä¿¡å·</span>                <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="ç«äº‰é€»è¾‘"><a href="#ç«äº‰é€»è¾‘" class="headerlink" title="ç«äº‰é€»è¾‘"></a>ç«äº‰é€»è¾‘</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>Node pred<span class="token punctuation">,</span> Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è·å–å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€ ï¼ˆå‰é¢æœ‰å†™ï¼Œå»ºè®®ç¿»çœ‹ï¼‰</span>    <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æˆç«‹ï¼šå‰ç½®èŠ‚ç‚¹æ˜¯å¯ä»¥å”¤é†’å½“å‰èŠ‚ç‚¹çš„ï¼Œè¿”å› true åï¼ŒparkAndCheckInterrupt parkå½“å‰çº¿ç¨‹</span>    <span class="token comment" spellcheck="true">// æ™®é€šæƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡æ¥åˆ° è¯¥æ–¹æ³• ws ä¸ä¼šæ˜¯ -1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ws > 0 è¡¨ç¤ºå‰ç½®èŠ‚ç‚¹æ˜¯ CANCELED çŠ¶æ€</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å”¤é†’ canceled èŠ‚ç‚¹çš„æ¡ä»¶æ˜¯å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹çš„ ws ä¸º-1</span>        <span class="token comment" spellcheck="true">// é‚£ä¹ˆè¿™ä¸ª do while å¾ªç¯å°±ä¸æ–­åœ°å‘å‰æ‰¾çŠ¶æ€ä¸å¤§äº 0 çš„èŠ‚ç‚¹</span>        <span class="token comment" spellcheck="true">// é‚£ä¹ˆ ws > 0 çš„èŠ‚ç‚¹ä¼šå‡ºé˜Ÿï¼ˆä¸‹é¢æœ‰å›¾ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ï¼‰</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰ node å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€ä¸º 0ï¼Œ</span>        <span class="token comment" spellcheck="true">// åˆ™ä¼šå°†å½“å‰çº¿ç¨‹ node å‰ç½®èŠ‚ç‚¹çŠ¶æ€å¼ºåˆ¶è®¾ç½®ä¸º SINGNAL</span>        <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æ€»ç»“ï¼š</p><ol><li>å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œç¬¬ä¸€æ¬¡æ¥åˆ°è¿™ä¸ªæ–¹æ³•æ—¶ä¼šè¶Šè¿‡å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œç¬¬äºŒæ¬¡ä¼šè¿”å› trueï¼Œç„¶å park å½“å‰çº¿ç¨‹ã€‚</li><li>å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹çŠ¶æ€æ˜¯ 0ï¼Œå½“å‰çº¿ç¨‹ä¼šè®¾ç½®å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€ä¸º -1ï¼Œç¬¬äºŒæ¬¡è‡ªæ—‹æ¥åˆ°è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œä¼šè¿”å›true ç„¶å Park å½“å‰çº¿ç¨‹ã€‚</li></ol><p>æ¥ä¸‹æ¥æ˜¯ parkAndCheckInterruptï¼ˆï¼‰</p><p>å®ƒæ˜¯ AQS çš„æ–¹æ³•ï¼Œpark å½“å‰çº¿ç¨‹ å°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œå”¤é†’åè¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºä¸­æ–­ä¿¡å·å”¤é†’ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="é€šç¯‡æ€»ç»“"><a href="#é€šç¯‡æ€»ç»“" class="headerlink" title="é€šç¯‡æ€»ç»“"></a>é€šç¯‡æ€»ç»“</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»¥ä¸Šå°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€ååœ¨æ¦‚è¿°ä¸€éåšä¸ªæ€»ç»“å§ï¼Œä¸»è¦æ˜¯æƒ³æ¢³ç†ä¸€ä¸‹æ‰€æœ‰çš„æºç çŸ¥è¯†ç‚¹ï¼Œæ¯•ç«Ÿæ— è®ºæ˜¯é¢è¯•è¿˜æ˜¯ä¸äººè®¨è®ºæˆ‘ä»¬éƒ½è¦å¤§è‡´è¯´ä¸€ä¸‹ï¼Œæ€»ä¸èƒ½ä¸Šæ¥å°±æ»´æ°´ä¸æ¼åœ°å°†æ•´ä½“ç»†èŠ‚å…¨éƒ¨æè¿°å‡ºæ¥ã€‚</p><p>â‘  å¦‚æœæˆ‘ä»¬ç”¨çš„æ˜¯å…¬å¹³é”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦è°ƒç”¨FairSync çš„ lock() ã€‚</p><p>â‘¡ ç„¶å lock è°ƒç”¨ acquireï¼Œå‚æ•°ä¼ å…¥ 1ï¼Œè®¾ç½® AQSçš„ state çš„å€¼ã€‚</p><p>â‘¢ è¿›å…¥ acquire æˆ‘ä»¬é¦–å…ˆè¦å°è¯•æ‹¿åˆ°é”ï¼ˆtryAcquireï¼‰,æ€ä¹ˆå»å°è¯•æ‹¿åˆ°é”å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ˜¯è·å–å½“å‰çº¿ç¨‹ï¼Œé€šè¿‡å½“å‰çº¿ç¨‹è·å–å½“å‰çº¿ç¨‹çš„çŠ¶æ€å€¼ï¼ˆstateï¼‰ï¼Œå¦‚æœçŠ¶æ€å€¼ä¸º 0ï¼Œè¯´æ˜ç°åœ¨æ˜¯æ— é”çŠ¶æ€ã€‚ç„¶ååˆ¤æ–­å½“å‰çº¿ç¨‹å‰é¢æœ‰æ²¡æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼ˆhasQueuedPredecessorsï¼‰ï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆå°±é€šè¿‡ cas çš„æ–¹å¼å»è®¾ç½® stateå€¼ï¼ˆcompareAndSetStateï¼‰ã€‚å¦‚æœè®¾ç½® state å€¼æˆåŠŸäº†ï¼Œè¯´æ˜æˆ‘ä»¬æŠ¢å é”æˆåŠŸäº†ã€‚æŠŠå½“å‰çº¿ç¨‹è®¾ç½®æˆç‹¬å è€…çº¿ç¨‹ï¼ˆsetExclusiveOwnerThreadï¼‰ï¼Œç„¶åå°±è¿”å› true äº†ã€‚å¦‚æœé”é‡å…¥äº†å‘¢ï¼Œæ›´æ–° state å€¼ï¼Œå†æ¬¡è®¾ç½®æ–°çš„ stateï¼Œæœ€åè¿”å› true;</p><p>â‘£ å¦‚æœæ²¡æœ‰æ‹¿åˆ°é”ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šå°†å½“å‰çº¿ç¨‹å°è£…æˆä¸€ä¸ª Node èŠ‚ç‚¹ï¼Œç„¶åå°†è¿™ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‚</p><p>â‘¤è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­æˆ‘ä»¬è¿˜è¦çœ‹çœ‹å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ park çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯é‚£ä¹ˆå°±å°†å…¶æŒ‚èµ·ã€‚å¹¶ä¸”å”¤é†’çº¿ç¨‹çš„é€»è¾‘ä¹Ÿåœ¨è¿™ä¸ªæ–¹æ³•é‡Œã€‚ä½†å”¤é†’çš„é€»è¾‘è¦ä¸‹æ¬¡å†è®²ã€‚åˆ°æ­¤æ•´ä¸ªåŠ é”çš„è¿‡ç¨‹å…¨éƒ¨å®Œæˆã€‚</p><h3 id="æ„Ÿè°¢"><a href="#æ„Ÿè°¢" class="headerlink" title="æ„Ÿè°¢"></a>æ„Ÿè°¢</h3><p>ä»¥ä¸Šæ–‡çŒ®èµ„æ–™æ¥è‡ª B ç«™ â€<strong>å°åˆ˜æ€æºç </strong>â€œï¼Œåœ¨æ­¤æ„Ÿè°¢å°åˆ˜è€å¸ˆã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Java é™¤äº†ä½¿ç”¨å…³é”®å­— synchronized å¤–ï¼Œè¿˜ä½¿ç”¨äº† ReentrantLock å®ç°ç‹¬å ã€å¯é‡å…¥é”çš„åŠŸèƒ½ã€‚ç›¸è¾ƒäº synchronizedï¼ŒReentrantLoc</summary>
      
    
    
    
    <category term="AQS" scheme="http://example.com/categories/AQS/"/>
    
    
    <category term="Java" scheme="http://example.com/tags/Java/"/>
    
  </entry>
  
</feed>
